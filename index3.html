<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Sınavı Yönet - EduManage</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#6366f1", // Indigo 500
                        "primary-hover": "#4f46e5", // Indigo 600
                        "background-dark": "#0f172a", // Slate 900
                        "surface-dark": "#1e293b", // Slate 800
                        "card-dark": "#334155", // Slate 700
                        "border-dark": "#334155",
                        "text-main": "#f8fafc", // Slate 50
                        "text-muted": "#94a3b8", // Slate 400
                    },
                    fontFamily: { "display": ["Lexend", "sans-serif"], "body": ["Inter", "sans-serif"] },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'slide-in-up': 'slideInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        slideInUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Lexend', sans-serif; }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .scale-in { animation: scaleIn 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Hide scrollbar for clean UI but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .option-card { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            background: rgba(51, 65, 85, 0.4);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .option-card:hover { transform: translateY(-1px); background: rgba(51, 65, 85, 0.7); border-color: rgba(255,255,255,0.1); }
        .option-card.selected-correct { border-color: #10b981; background-color: rgba(16, 185, 129, 0.15); color: #34d399; box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); }
        .option-card.selected-wrong { border-color: #ef4444; background-color: rgba(239, 68, 68, 0.15); color: #f87171; box-shadow: 0 0 10px rgba(239, 68, 68, 0.1); }
        .option-card.disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; transform: none !important; filter: grayscale(0.4); }

        /* Staggered Animation Delays */
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
        .delay-400 { animation-delay: 400ms; }
        .delay-500 { animation-delay: 500ms; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-background-dark text-slate-900 dark:text-text-main transition-colors duration-200 min-h-screen flex overflow-hidden selection:bg-primary selection:text-white">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-background-dark flex items-center justify-center p-4 overflow-hidden">
        <!-- Background Blobs -->
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-primary/20 rounded-full blur-3xl animate-blob"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-purple-500/20 rounded-full blur-3xl animate-blob delay-200"></div>

        <div class="w-full max-w-sm glass-panel p-8 rounded-3xl shadow-2xl text-center fade-in relative z-10">
            <div class="bg-gradient-to-tr from-primary to-purple-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-primary/20">
                <span class="material-symbols-rounded text-white text-3xl">school</span>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2 tracking-tight">EduManage</h1>
            <p class="text-text-muted text-sm mb-8">Öğrenme sürecini yönet.</p>
            
            <div id="config-error" class="hidden mb-4 bg-red-500/10 border border-red-500/50 p-4 rounded-xl text-left">
                <p class="text-red-400 text-xs font-bold flex items-center gap-2"><span class="material-symbols-rounded text-base">error</span> Yapılandırma Hatası</p>
            </div>

            <form onsubmit="handleAuth(event)" class="space-y-4 text-left">
                <div class="group">
                    <input type="email" name="email" required placeholder="E-posta" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3.5 text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder:text-zinc-600">
                </div>
                <div class="group">
                    <input type="password" name="password" required placeholder="Şifre" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3.5 text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder:text-zinc-600">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-primary hover:bg-primary-hover text-white py-3.5 rounded-xl font-bold text-sm transition-all shadow-lg shadow-primary/25 flex items-center justify-center gap-2 mt-2 hover:scale-[1.02] active:scale-[0.98]">
                    <span>Giriş Yap</span>
                </button>
            </form>

            <div class="my-4 flex items-center gap-3">
                <div class="h-px flex-1 bg-white/10"></div>
                <span class="text-xs text-slate-500 font-medium">veya</span>
                <div class="h-px flex-1 bg-white/10"></div>
            </div>

            <button onclick="handleGuestLogin()" id="guest-login-btn" class="w-full bg-white/5 hover:bg-white/10 text-white py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 border border-white/5 hover:border-white/10">
                <span class="material-symbols-rounded text-base">person</span> Misafir Olarak Devam Et
            </button>

            <div class="mt-6 pt-6 border-t border-white/5">
                <button onclick="toggleAuthMode()" class="text-primary text-sm font-bold hover:text-primary-hover hover:underline w-full text-center" id="auth-toggle-btn">Hesap Oluştur</button>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-wrapper" class="flex w-full h-full hidden fade-in bg-background-dark">
        <!-- Sidebar -->
        <aside class="w-64 glass-panel border-r-0 border-white/5 flex-col hidden lg:flex shrink-0 h-screen z-20 m-3 ml-3 my-3 rounded-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-primary/10 to-transparent pointer-events-none"></div>
            
            <div class="h-20 flex items-center px-6 relative z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-primary/20 p-1.5 rounded-lg">
                        <span class="material-symbols-rounded text-primary text-xl">school</span>
                    </div>
                    <span class="text-lg font-bold text-white tracking-tight">EduManage</span>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto py-2 px-3 flex flex-col gap-1 relative z-10">
                <div class="mb-6 p-3 bg-white/5 rounded-xl border border-white/5 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm shadow-inner shrink-0">
                        <span id="user-avatar-initial">K</span>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-medium text-text-muted">Hoşgeldin,</p>
                        <p class="text-sm font-bold text-white leading-tight truncate" id="user-email-display">...</p>
                    </div>
                </div>

                <p class="px-3 text-[10px] font-bold text-zinc-500 uppercase tracking-wider mb-2 mt-2">Menü</p>
                <button onclick="router('dashboard')" id="nav-dashboard" class="flex items-center gap-3 px-3 py-3 rounded-xl text-text-muted hover:bg-white/5 hover:text-white transition-all w-full text-left group">
                    <span class="material-symbols-rounded text-[20px] group-hover:text-primary transition-colors">dashboard</span>
                    <span class="text-sm font-medium">Genel Bakış</span>
                </button>
                <button onclick="router('content')" id="nav-content" class="flex items-center gap-3 px-3 py-3 rounded-xl text-text-muted hover:bg-white/5 hover:text-white transition-all w-full text-left group">
                    <span class="material-symbols-rounded text-[20px] group-hover:text-primary transition-colors">library_books</span>
                    <span class="text-sm font-medium">Test Kütüphanesi</span>
                </button>
                
                <div class="mt-auto pt-4 border-t border-white/5">
                    <button onclick="handleLogout()" class="flex items-center gap-3 px-3 py-3 rounded-xl text-text-muted hover:bg-red-500/10 hover:text-red-400 transition-all w-full text-left group">
                        <span class="material-symbols-rounded text-[20px]">logout</span>
                        <span class="text-sm font-medium">Çıkış</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
            <!-- Mobile Header -->
            <div class="lg:hidden h-16 glass-panel border-b border-white/5 flex items-center justify-between px-4 shrink-0 z-30 m-3 rounded-2xl">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-rounded text-primary">school</span>
                    <span class="font-bold text-white">EduManage</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="router('dashboard')" class="p-2 text-zinc-400"><span class="material-symbols-rounded">dashboard</span></button>
                    <button onclick="router('content')" class="p-2 text-zinc-400"><span class="material-symbols-rounded">library_books</span></button>
                </div>
            </div>

            <!-- Dynamic Content Area -->
            <div id="app-container" class="flex-1 overflow-y-auto overflow-x-hidden p-0 md:p-4 flex flex-col h-full relative scroll-smooth">
                <!-- Loader -->
                <div class="flex justify-center items-center h-full">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-lg shadow-2xl transform scale-95 opacity-0 transition-all duration-300 flex flex-col max-h-[90vh]" id="modal-content">
            <div class="p-6 border-b border-white/10 flex justify-between items-center shrink-0">
                <h3 id="modal-title" class="text-lg font-bold text-white">Başlık</h3>
                <button onclick="closeModal()" class="text-zinc-400 hover:text-white transition-colors bg-white/5 hover:bg-white/10 p-1.5 rounded-full">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto thin-scroll">
                <!-- Dynamic Form -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 glass-panel border border-emerald-500/30 text-emerald-400 px-5 py-4 rounded-2xl shadow-xl transform translate-y-32 opacity-0 transition-all duration-300 z-[80] flex items-center gap-3 text-sm font-bold">
        <span class="material-symbols-rounded filled text-xl">check_circle</span>
        <span id="toast-message">Başarılı</span>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const myFirebaseConfig = {
             apiKey: "AIzaSyBRyvBSrNc5QKFWiMryYbHG-s4DXf4IIrc",
             authDomain: "kpss-takip-75477.firebaseapp.com",
             projectId: "kpss-takip-75477",
             storageBucket: "kpss-takip-75477.firebasestorage.app",
             messagingSenderId: "1083935832054",
             appId: "1:1083935832054:web:d02f57e3721e39f286b9d7",
             measurementId: "G-QFLEBQEHBC"
        };
        const firebaseConfig = (envConfig.apiKey) ? envConfig : myFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app, auth, db;
        try {
            if (!firebaseConfig.apiKey) {
                document.getElementById('config-error').classList.remove('hidden');
                document.getElementById('auth-submit-btn').disabled = true;
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch(e) {
            console.error(e);
            document.getElementById('config-error').classList.remove('hidden');
        }

        // --- State ---
        let currentUser = null;
        let categories = [], subcategories = [], tests = [], questions = [], results = [];
        let loading = true;
        let dbError = null;
        let currentView = 'dashboard'; 
        let contentFilter = { catId: 'all', subId: 'all', search: '' };
        let activeQuizData = null; 
        let isLoginMode = true;
        let currentEditingId = null;

        // --- Auth Functions ---
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            const btn = document.getElementById('auth-submit-btn');
            const toggle = document.getElementById('auth-toggle-btn');
            if (isLoginMode) {
                btn.querySelector('span').innerText = "Giriş Yap";
                toggle.innerText = "Hesap Oluştur";
            } else {
                btn.querySelector('span').innerText = "Kayıt Ol";
                toggle.innerText = "Giriş Yap";
            }
        };

        window.handleAuth = async (e) => {
            e.preventDefault();
            if (!auth) { showToast("Firebase Hatası: Bağlantı yok.", "error"); return; }
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const btn = document.getElementById('auth-submit-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>`;

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (err) {
                console.error(err);
                let msg = "İşlem başarısız.";
                if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') msg = "Hatalı e-posta veya şifre.";
                else if (err.code === 'auth/email-already-in-use') msg = "Bu e-posta zaten kullanımda.";
                else if (err.code === 'auth/weak-password') msg = "Şifre çok zayıf (en az 6 karakter).";
                else if (err.code === 'auth/network-request-failed') msg = "Bağlantı hatası. İnternetinizi kontrol edin.";
                
                showToast(msg, "error");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        window.handleGuestLogin = async () => {
             const btn = document.getElementById('guest-login-btn');
             const originalText = btn.innerHTML;
             btn.innerHTML = `<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>`;
             btn.disabled = true;
             try {
                 await signInAnonymously(auth);
             } catch(e) { 
                 showToast("Misafir girişi başarısız: " + e.message, "error");
                 btn.innerHTML = originalText; btn.disabled = false;
             }
        }

        window.handleLogout = async () => { if(auth) { await signOut(auth); location.reload(); } };

        // --- Core Functions ---
        async function init() {
            if (!auth) return;
            
            // Try auto-login with token from environment if available
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (e) { console.error("Token login failed", e); }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    const displayEmail = user.isAnonymous ? "Misafir Kullanıcı" : user.email;
                    document.getElementById('user-avatar-initial').innerText = displayEmail.charAt(0).toUpperCase();
                    document.getElementById('user-email-display').innerText = displayEmail;
                    
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-wrapper').classList.remove('hidden');
                    startListeners();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-wrapper').classList.add('hidden');
                }
            });
        }

        function startListeners() {
            if(!currentUser) return;
            const userPath = `artifacts/${appId}/users/${currentUser.uid}`;
            const handleSnap = (setter, snap) => { setter(snap.docs.map(d => ({ id: d.id, ...d.data() }))); checkLoading(); };
            const handleError = (err) => { console.error("Firestore Error:", err); dbError = err.message; loading = false; refreshUI(); };

            onSnapshot(collection(db, userPath, 'categories'), (s) => handleSnap(d => categories = d, s), handleError);
            onSnapshot(collection(db, userPath, 'subcategories'), (s) => handleSnap(d => subcategories = d, s), handleError);
            onSnapshot(collection(db, userPath, 'tests'), (s) => handleSnap(d => tests = d, s), handleError);
            onSnapshot(collection(db, userPath, 'questions'), (s) => handleSnap(d => questions = d, s), handleError);
            onSnapshot(collection(db, userPath, 'results'), (s) => handleSnap(d => results = d, s), handleError);
        }

        function checkLoading() { if(loading) { loading = false; refreshUI(); } else { refreshUI(); } }

        window.router = function(view) {
            currentView = view;
            if (view !== 'content') { contentFilter = { catId: 'all', subId: 'all', search: '' }; }
            updateNavStyles(view);
            render();
        }

        window.toggleCategory = (id) => {
            if (contentFilter.catId === id) { contentFilter.catId = 'all'; } else { contentFilter.catId = id; }
            contentFilter.subId = 'all';
            refreshUI();
        };

        window.filterBySubCategory = (id) => { contentFilter.subId = id; refreshUI(); };

        function updateNavStyles(view) {
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('bg-white/5', 'text-white'));
            const activeBtn = document.getElementById(`nav-${view}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-text-muted', 'hover:bg-white/5', 'hover:text-white');
                activeBtn.classList.add('bg-primary/20', 'text-white'); 
            }
        }

        function refreshUI() { render(); }

        function render() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';

            if (dbError) {
                container.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full fade-in p-8 text-center">
                        <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center text-red-500 mb-4"><span class="material-symbols-rounded text-3xl">error</span></div>
                        <h2 class="text-xl font-bold text-white mb-2">Veri Erişim Hatası</h2>
                        <p class="text-text-muted text-sm max-w-md">${dbError}</p>
                    </div>`;
                return;
            }

            if (loading) {
                container.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full fade-in">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary mb-4"></div>
                        <p class="text-text-muted text-sm animate-pulse">Yükleniyor...</p>
                    </div>`;
                return;
            }

            if (currentView === 'dashboard') renderDashboard(container);
            else if (currentView === 'content') renderContentSplit(container);
            else if (currentView === 'quiz_active') renderActiveQuiz(container);
            else if (currentView === 'quiz_review') renderQuizReview(container);
        }

        // --- DASHBOARD ---
        function renderDashboard(container) {
            const totalTestsSolved = results.length;
            const totalCorrect = results.reduce((acc, curr) => acc + (curr.score || 0), 0);
            const totalPossible = results.reduce((acc, curr) => acc + (curr.totalQuestions || 0), 0);
            const overallSuccess = totalPossible > 0 ? Math.round((totalCorrect / totalPossible) * 100) : 0;
            const totalErrors = totalPossible - totalCorrect;

            const catStats = {};
            categories.forEach(c => catStats[c.id] = { name: c.name, correct: 0, total: 0 });
            results.forEach(r => {
                const test = tests.find(t => t.id === r.testId);
                if(test) {
                    const sub = subcategories.find(s => s.id === test.subId);
                    if(sub && catStats[sub.catId]) { catStats[sub.catId].correct += r.score; catStats[sub.catId].total += r.totalQuestions; }
                }
            });

            const recentResults = [...results].sort((a,b) => b.timestamp - a.timestamp).slice(0, 5);

            if (categories.length === 0 && tests.length === 0) {
                 container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-center p-8 fade-in">
                        <div class="glass-panel p-8 rounded-3xl max-w-sm">
                            <div class="w-16 h-16 bg-primary/20 rounded-2xl flex items-center justify-center text-primary text-3xl mb-6 mx-auto"><span class="material-symbols-rounded">school</span></div>
                            <h2 class="text-xl font-bold text-white mb-2">Hoş Geldiniz!</h2>
                            <p class="text-text-muted text-sm mb-6">Test kütüphaneniz boş. Hemen ilk testinizi oluşturun.</p>
                            <button onclick="openModal('global-test-json')" class="w-full bg-primary hover:bg-primary-hover text-white py-3 rounded-xl font-bold text-sm shadow-lg">İlk Testi Oluştur</button>
                        </div>
                    </div>`;
                return;
            }
            
            const statsHtml = Object.values(catStats).filter(c => c.total > 0).map(c => {
                const pct = Math.round((c.correct / c.total) * 100);
                let colorClass = pct >= 70 ? 'bg-emerald-500' : (pct >= 50 ? 'bg-yellow-500' : 'bg-red-500');
                return `
                <div class="mb-5">
                    <div class="flex justify-between text-xs font-bold mb-2">
                        <span class="text-slate-300 tracking-wide">${c.name}</span>
                        <span class="${pct >= 70 ? 'text-emerald-400' : (pct >= 50 ? 'text-yellow-400' : 'text-red-400')}">%${pct}</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-2.5 overflow-hidden border border-white/5">
                        <div class="${colorClass} h-full rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: ${pct}%"></div>
                    </div>
                </div>`;
            }).join('') || '<p class="text-text-muted text-xs italic text-center py-4">Henüz veri yok.</p>';

            const historyHtml = recentResults.map(r => {
                const t = tests.find(x => x.id === r.testId);
                const date = new Date(r.timestamp).toLocaleDateString('tr-TR', {day:'numeric', month:'short'});
                const pct = Math.round((r.score/r.totalQuestions)*100);
                const gradeColor = pct >= 70 ? 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20' : 'text-slate-400 bg-slate-700/30 border-slate-600/30';
                return `
                <div class="flex items-center justify-between p-3.5 hover:bg-white/5 rounded-xl transition-all mb-2 border border-transparent hover:border-white/5">
                    <div class="flex items-center gap-3.5">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center border text-xs font-bold ${gradeColor}">
                            <span>%${pct}</span>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-white text-sm font-bold truncate w-32 md:w-48">${t ? t.title : 'Silinmiş Test'}</p>
                            <p class="text-[10px] text-text-muted mt-0.5">${date}</p>
                        </div>
                    </div>
                    <span class="text-xs font-medium text-slate-400">${r.score}/${r.totalQuestions} D</span>
                </div>`;
            }).join('') || '<p class="text-text-muted text-xs p-4 text-center">Henüz test çözmediniz.</p>';

            container.innerHTML = `
                <div class="fade-in max-w-6xl mx-auto w-full pb-10 p-4">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold tracking-tight text-white">Genel Bakış</h2>
                        <p class="text-text-muted text-sm mt-1">Performans ve istatistiklerin.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
                        <div class="glass-panel p-6 rounded-3xl flex items-center gap-5 relative overflow-hidden group">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl group-hover:bg-emerald-500/20 transition-all"></div>
                            <div class="w-14 h-14 rounded-2xl bg-emerald-500/20 flex items-center justify-center text-emerald-400 shadow-lg shadow-emerald-500/10"><span class="material-symbols-rounded text-2xl">check_circle</span></div>
                            <div><p class="text-text-muted font-medium text-xs uppercase tracking-wider">Genel Başarı</p><p class="text-3xl font-black text-white mt-1">%${overallSuccess}</p></div>
                        </div>
                        <div class="glass-panel p-6 rounded-3xl flex items-center gap-5 relative overflow-hidden group">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-primary/10 rounded-full blur-2xl group-hover:bg-primary/20 transition-all"></div>
                            <div class="w-14 h-14 rounded-2xl bg-primary/20 flex items-center justify-center text-primary shadow-lg shadow-primary/10"><span class="material-symbols-rounded text-2xl">quiz</span></div>
                            <div><p class="text-text-muted font-medium text-xs uppercase tracking-wider">Çözülen Test</p><p class="text-3xl font-black text-white mt-1">${totalTestsSolved}</p></div>
                        </div>
                         <div class="glass-panel p-6 rounded-3xl flex items-center gap-5 relative overflow-hidden group">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-red-500/10 rounded-full blur-2xl group-hover:bg-red-500/20 transition-all"></div>
                            <div class="w-14 h-14 rounded-2xl bg-red-500/20 flex items-center justify-center text-red-400 shadow-lg shadow-red-500/10"><span class="material-symbols-rounded text-2xl">warning</span></div>
                            <div><p class="text-text-muted font-medium text-xs uppercase tracking-wider">Hatalı Cevap</p><p class="text-3xl font-black text-white mt-1">${totalErrors}</p></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 glass-panel rounded-3xl p-8">
                            <h3 class="font-bold text-white mb-6 text-sm uppercase tracking-wider flex items-center gap-2">
                                <span class="w-1 h-4 bg-primary rounded-full"></span> Ders Bazlı Başarı
                            </h3>
                            <div class="space-y-1">
                                ${statsHtml}
                            </div>
                        </div>

                        <div class="glass-panel rounded-3xl overflow-hidden h-fit">
                             <div class="p-6 border-b border-white/5 bg-white/[0.02]">
                                <h3 class="font-bold text-white text-sm uppercase tracking-wider flex items-center gap-2">
                                    <span class="w-1 h-4 bg-purple-500 rounded-full"></span> Son Aktiviteler
                                </h3>
                             </div>
                             <div class="p-4">
                                ${historyHtml}
                             </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- CONTENT PAGE ---
        function renderContentSplit(container) {
            let filteredTests = tests;
            if (contentFilter.catId !== 'all') {
                const validSubIds = subcategories.filter(s => s.catId === contentFilter.catId).map(s => s.id);
                filteredTests = filteredTests.filter(t => validSubIds.includes(t.subId));
            }
            if (contentFilter.subId !== 'all') {
                filteredTests = filteredTests.filter(t => t.subId === contentFilter.subId);
            }
            if (contentFilter.search) {
                filteredTests = filteredTests.filter(t => t.title.toLowerCase().includes(contentFilter.search.toLowerCase()));
            }

            const sidebarHtml = `
                <div class="w-64 shrink-0 glass-panel flex flex-col gap-4 overflow-y-auto hidden md:flex thin-scroll rounded-2xl m-4 mr-0 p-4">
                    <div class="flex justify-between items-center px-1 pb-2 border-b border-white/5">
                        <h3 class="font-bold text-white text-sm">Filtrele</h3>
                        <button onclick="openModal('category')" class="text-primary hover:text-white transition-colors text-xs font-bold py-1 px-2 rounded-lg hover:bg-white/5">+ Ekle</button>
                    </div>
                    <div class="space-y-1">
                        <button onclick="toggleCategory('all')" class="w-full text-left px-3 py-2.5 rounded-xl text-xs font-bold transition-all ${contentFilter.catId === 'all' ? 'bg-primary text-white shadow-lg shadow-primary/20' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                            Tüm Testler
                        </button>
                        ${categories.map(c => `
                            <div>
                                <div class="flex items-center justify-between group rounded-xl transition-colors mt-1 ${contentFilter.catId === c.id ? 'bg-white/5' : 'hover:bg-white/5'}">
                                    <button onclick="toggleCategory('${c.id}')" class="flex-1 text-left px-3 py-2.5 text-xs font-bold ${contentFilter.catId === c.id ? 'text-white' : 'text-slate-400 group-hover:text-white'}">
                                        ${c.name}
                                    </button>
                                    <div class="flex items-center pr-2 gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openModal('subcategory', '${c.id}')" class="text-slate-500 hover:text-emerald-400 p-1"><span class="material-symbols-rounded text-[14px]">add</span></button>
                                        <button onclick="deleteItem('categories', '${c.id}')" class="text-slate-500 hover:text-red-400 p-1"><span class="material-symbols-rounded text-[14px]">delete</span></button>
                                    </div>
                                </div>
                                ${contentFilter.catId === c.id ? `
                                    <div class="pl-4 space-y-0.5 mt-1 border-l border-white/10 ml-3">
                                        ${subcategories.filter(s => s.catId === c.id).map(s => `
                                            <div class="flex items-center justify-between group py-1.5 pr-2 pl-3 rounded-lg hover:bg-white/5">
                                                <button onclick="filterBySubCategory('${s.id}')" class="text-left text-[11px] font-medium transition-colors ${contentFilter.subId === s.id ? 'text-primary' : 'text-slate-500 hover:text-slate-300'}">
                                                    ${s.name}
                                                </button>
                                                 <button onclick="deleteItem('subcategories', '${s.id}')" class="opacity-0 group-hover:opacity-100 text-slate-600 hover:text-red-500"><span class="material-symbols-rounded text-[12px]">close</span></button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>`;

            let cardsHtml = filteredTests.length === 0 
                ? `<div class="p-12 text-center text-slate-500 border border-dashed border-white/10 rounded-3xl col-span-full bg-white/[0.01]">
                    <span class="material-symbols-rounded text-4xl mb-2 opacity-50">search_off</span><br>
                    Test bulunamadı. <br> 
                    <button onclick="openModal('global-test-json')" class="text-primary hover:text-white mt-3 font-bold text-sm bg-primary/10 px-4 py-2 rounded-xl transition-all">Yeni Test Ekle</button>
                   </div>`
                : filteredTests.map((t, index) => {
                    const subcat = subcategories.find(s => s.id === t.subId);
                    const cat = subcat ? categories.find(c => c.id === subcat.catId) : null;
                    const result = results.filter(r => r.testId === t.id).sort((a,b) => b.timestamp - a.timestamp)[0];
                    
                    return `
                    <div class="glass-panel p-5 rounded-2xl flex flex-col h-full relative group hover:border-primary/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-primary/5 slide-up" style="animation-delay: ${index * 50}ms">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-slate-500 text-[10px] uppercase font-bold truncate max-w-[70%] tracking-wider bg-white/5 px-2 py-1 rounded-md">
                                ${cat?.name || 'Genel'} / ${subcat?.name || 'Genel'}
                            </span>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-black/40 rounded-lg p-0.5 backdrop-blur-sm">
                                <button onclick="openModal('global-test-json', '${t.id}')" class="text-slate-400 hover:text-primary p-1"><span class="material-symbols-rounded text-[16px]">edit</span></button>
                                <button onclick="deleteItem('tests', '${t.id}')" class="text-slate-400 hover:text-red-400 p-1"><span class="material-symbols-rounded text-[16px]">delete</span></button>
                            </div>
                        </div>

                        <h3 class="text-base font-bold text-white leading-snug mb-3 line-clamp-2">${t.title}</h3>
                        ${result 
                            ? `<div class="text-emerald-400 text-xs font-bold mb-4 flex items-center gap-1.5 bg-emerald-500/10 w-fit px-2 py-1 rounded-lg border border-emerald-500/20"><span class="material-symbols-rounded text-[14px]">check_circle</span> Tamamlandı</div>` 
                            : '<div class="h-8 mb-3"></div>' 
                        }
                        
                        <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                            <span class="text-xs text-slate-500 font-medium flex items-center gap-1"><span class="material-symbols-rounded text-sm">format_list_bulleted</span> ${t.questionCount || 0}</span>
                            <button onclick="startQuiz('${t.id}')" class="bg-white text-slate-900 hover:bg-slate-200 px-5 py-2 rounded-xl text-xs font-bold transition-all shadow-lg active:scale-95">
                                ${result ? 'Tekrar' : 'Başla'}
                            </button>
                        </div>
                    </div>`;
                }).join('');

            container.innerHTML = `
                <div class="flex h-full fade-in gap-4 md:gap-6 overflow-hidden">
                    ${sidebarHtml}
                    <div class="flex-1 flex flex-col h-full overflow-hidden p-4 pl-0">
                        <div class="flex justify-between items-center mb-6 shrink-0 gap-4">
                            <div class="relative flex-1 max-w-md group">
                                <span class="material-symbols-rounded absolute left-3.5 top-3 text-slate-500 text-lg transition-colors group-focus-within:text-primary">search</span>
                                <input type="text" placeholder="Test kütüphanesinde ara..." oninput="contentFilter.search=this.value; refreshUI()" value="${contentFilter.search}" class="w-full bg-slate-900/50 border border-slate-700/50 rounded-2xl py-2.5 pl-11 pr-4 text-sm text-white focus:ring-1 focus:ring-primary focus:border-primary outline-none transition-all shadow-inner">
                            </div>
                            <button onclick="openModal('global-test-json')" class="bg-primary hover:bg-primary-hover text-white px-5 py-2.5 rounded-2xl text-xs font-bold shadow-lg shadow-primary/20 flex items-center gap-2 shrink-0 hover:scale-105 active:scale-95 transition-all">
                                <span class="material-symbols-rounded text-base">add_circle</span> Yeni Test
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto pr-2 thin-scroll pb-20">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                                ${cardsHtml}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- NEW MINIMAL QUIZ UI (COMPACT & FIXED LAYOUT) ---
        
        window.startQuiz = (testId) => {
            const test = tests.find(t => t.id === testId);
            const qs = questions.filter(q => q.testId === testId);
            if(qs.length === 0) return showToast("Hata", "Bu testte soru bulunmuyor.", "error");
            activeQuizData = { test, questions: qs, answers: {}, currentIndex: 0 };
            router('quiz_active');
        }

        window.submitQuiz = async () => {
            if(!confirm("Testi bitirmek istiyor musun?")) return;
            let correct = 0;
            activeQuizData.questions.forEach(q => { if(activeQuizData.answers[q.id] == q.correctIndex) correct++; });
            const userPath = `artifacts/${appId}/users/${currentUser.uid}`;
            try {
                await addDoc(collection(db, userPath, 'results'), { testId: activeQuizData.test.id, score: correct, totalQuestions: activeQuizData.questions.length, timestamp: Date.now() });
                router('quiz_review');
            } catch(e) { console.error(e); }
        }

        window.selectOption = (qId, index) => {
            if (activeQuizData.answers[qId] !== undefined) return; 
            activeQuizData.answers[qId] = index;
            
            const q = activeQuizData.questions[activeQuizData.currentIndex];
            
            // UI Update Logic
            q.options.forEach((_, i) => {
                const btn = document.getElementById(`opt-btn-${i}`);
                if(!btn) return;
                
                btn.disabled = true;
                btn.classList.remove('hover:bg-slate-700/50', 'hover:border-white/10');
                btn.classList.add('cursor-default');

                if (i === q.correctIndex) {
                    btn.classList.add('selected-correct');
                    btn.querySelector('.opt-letter').classList.replace('border-slate-500', 'border-emerald-400');
                    btn.querySelector('.opt-letter').classList.add('text-emerald-400');
                } else if (i === index) {
                    btn.classList.add('selected-wrong');
                    btn.querySelector('.opt-letter').classList.replace('border-slate-500', 'border-red-400');
                    btn.querySelector('.opt-letter').classList.add('text-red-400');
                } else {
                    btn.classList.add('disabled');
                }
            });

            const actionContainer = document.getElementById('quiz-header-actions');
            if(actionContainer) {
                const isLast = activeQuizData.currentIndex === activeQuizData.questions.length - 1;
                if (isLast) {
                    actionContainer.innerHTML = `<button onclick="submitQuiz()" class="bg-emerald-500 hover:bg-emerald-400 text-white px-5 py-2 rounded-xl text-xs font-bold shadow-lg shadow-emerald-500/20 flex items-center gap-2 animate-slide-in-up">Bitir <span class="material-symbols-rounded text-sm">check</span></button>`;
                } else {
                    actionContainer.innerHTML = `<button onclick="quizNav(1)" class="bg-white text-slate-900 hover:bg-slate-200 px-5 py-2 rounded-xl text-xs font-bold shadow-lg flex items-center gap-2 animate-slide-in-up">Sonraki <span class="material-symbols-rounded text-sm">arrow_forward</span></button>`;
                }
            }

            if (q.explanation) {
                const expContainer = document.getElementById('quiz-explanation-container');
                if(expContainer) {
                    expContainer.innerHTML = `
                        <div class="h-full overflow-y-auto thin-scroll slide-up bg-white/[0.02] p-4 rounded-xl border border-white/5">
                            <div class="flex items-center gap-2 text-primary-hover text-[10px] font-bold uppercase tracking-widest mb-2 sticky top-0 bg-transparent backdrop-blur-sm">
                                <span class="material-symbols-rounded text-sm">lightbulb</span> Açıklama
                            </div>
                            <p class="text-slate-300 text-sm leading-relaxed">${q.explanation}</p>
                        </div>`;
                }
            }
        }

        window.quizNav = (direction) => {
            const newIndex = activeQuizData.currentIndex + direction;
            if (newIndex >= 0 && newIndex < activeQuizData.questions.length) {
                activeQuizData.currentIndex = newIndex;
                
                const qText = document.getElementById('quiz-question-text');
                if (qText) {
                    const q = activeQuizData.questions[newIndex];
                    const progress = ((newIndex + 1) / activeQuizData.questions.length) * 100;
                    const ans = activeQuizData.answers[q.id];
                    const isAnswered = ans !== undefined;

                    // Fade text out/in effect
                    qText.style.opacity = '0';
                    setTimeout(() => { qText.innerText = q.text; qText.style.opacity = '1'; }, 150);

                    document.getElementById('quiz-counter-current').innerText = newIndex + 1;
                    document.getElementById('quiz-watermark').innerText = newIndex + 1;
                    document.getElementById('quiz-progress').style.width = `${progress}%`;

                    const optionsContainer = document.getElementById('quiz-options-list');
                    optionsContainer.innerHTML = q.options.map((opt, i) => {
                        let baseClass = "w-full text-left p-4 rounded-xl option-card relative overflow-hidden flex items-center gap-3 text-slate-200 text-sm font-medium animate-slide-in-up";
                        let statusClass = "hover:bg-slate-700/50 hover:border-white/10";
                        let letterClass = "border-slate-500 text-slate-400";
                        
                        if (isAnswered) {
                            if (i == q.correctIndex) { statusClass = "selected-correct"; letterClass = "border-emerald-400 text-emerald-400"; }
                            else if (i == ans) { statusClass = "selected-wrong"; letterClass = "border-red-400 text-red-400"; }
                            else statusClass = "disabled";
                        }

                        return `
                        <button id="opt-btn-${i}" onclick="selectOption('${q.id}', ${i})" class="${baseClass} ${statusClass}" ${isAnswered ? 'disabled' : ''} style="animation-delay: ${i * 100}ms">
                            <div class="opt-letter w-6 h-6 rounded-md border-2 ${letterClass} flex items-center justify-center text-[10px] font-bold transition-colors">
                                ${String.fromCharCode(65+i)}
                            </div>
                            <span class="leading-snug">${opt}</span>
                        </button>`;
                    }).join('');

                    const actionContainer = document.getElementById('quiz-header-actions');
                    if (isAnswered) {
                         const isLast = newIndex === activeQuizData.questions.length - 1;
                         if (isLast) {
                            actionContainer.innerHTML = `<button onclick="submitQuiz()" class="bg-emerald-500 hover:bg-emerald-400 text-white px-5 py-2 rounded-xl text-xs font-bold shadow-lg shadow-emerald-500/20 flex items-center gap-2">Bitir <span class="material-symbols-rounded text-sm">check</span></button>`;
                        } else {
                            actionContainer.innerHTML = `<button onclick="quizNav(1)" class="bg-white text-slate-900 hover:bg-slate-200 px-5 py-2 rounded-xl text-xs font-bold shadow-lg flex items-center gap-2">Sonraki <span class="material-symbols-rounded text-sm">arrow_forward</span></button>`;
                        }
                    } else {
                        actionContainer.innerHTML = '';
                    }

                    // RESET EXPLANATION AREA
                    const expContainer = document.getElementById('quiz-explanation-container');
                    if(expContainer) {
                        if (isAnswered && q.explanation) {
                             expContainer.innerHTML = `
                                <div class="h-full overflow-y-auto thin-scroll slide-up bg-white/[0.02] p-4 rounded-xl border border-white/5">
                                    <div class="flex items-center gap-2 text-primary-hover text-[10px] font-bold uppercase tracking-widest mb-2 sticky top-0 bg-transparent backdrop-blur-sm">
                                        <span class="material-symbols-rounded text-sm">lightbulb</span> Açıklama
                                    </div>
                                    <p class="text-slate-300 text-sm leading-relaxed">${q.explanation}</p>
                                </div>`;
                        } else {
                            expContainer.innerHTML = '<div class="h-full flex items-center justify-center text-white/10 text-xs uppercase font-bold tracking-widest border border-white/5 rounded-xl border-dashed">Açıklama Alanı</div>';
                        }
                    }

                } else {
                    render();
                }
            }
        }

        function renderActiveQuiz(container) {
            const { test, questions, currentIndex, answers } = activeQuizData;
            const q = questions[currentIndex];
            const ans = answers[q.id];
            const isAnswered = ans !== undefined;
            const progress = ((currentIndex + 1) / questions.length) * 100;

            container.innerHTML = `
                <div class="fixed inset-0 bg-background-dark z-[60] flex flex-col fade-in overflow-hidden">
                    <!-- Background Ambience -->
                    <div class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-primary/20 rounded-full blur-3xl opacity-50 animate-blob pointer-events-none"></div>
                    <div class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-purple-600/20 rounded-full blur-3xl opacity-50 animate-blob delay-500 pointer-events-none"></div>

                    <!-- Header -->
                    <div class="h-14 glass-panel border-b-0 border-white/5 px-6 md:px-10 flex items-center justify-between shrink-0 relative z-20">
                        <div class="flex items-center gap-6">
                            <button onclick="router('content')" class="text-slate-400 hover:text-white transition-colors flex items-center gap-2 text-xs font-bold uppercase tracking-wide group">
                                <span class="material-symbols-rounded text-lg group-hover:-translate-x-1 transition-transform">arrow_back</span> Çıkış
                            </button>
                            <div class="h-6 w-px bg-white/10"></div>
                            <div>
                                <h2 class="text-sm font-bold text-white truncate max-w-[200px] md:max-w-md">${test.title}</h2>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-xs font-mono text-slate-400 bg-white/5 px-3 py-1.5 rounded-lg border border-white/5"><span id="quiz-counter-current" class="text-white font-bold">${currentIndex + 1}</span> <span class="opacity-50">/</span> ${questions.length}</div>
                            <div id="quiz-header-actions">
                                ${isAnswered 
                                    ? (currentIndex === questions.length - 1
                                        ? `<button onclick="submitQuiz()" class="bg-emerald-500 hover:bg-emerald-400 text-white px-5 py-2 rounded-xl text-xs font-bold shadow-lg shadow-emerald-500/20 flex items-center gap-2 slide-up">Bitir <span class="material-symbols-rounded text-sm">check</span></button>`
                                        : `<button onclick="quizNav(1)" class="bg-white text-slate-900 hover:bg-slate-200 px-5 py-2 rounded-xl text-xs font-bold shadow-lg flex items-center gap-2 slide-up">Sonraki <span class="material-symbols-rounded text-sm">arrow_forward</span></button>`)
                                    : ''
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="h-1 bg-slate-800 w-full relative z-20">
                        <div id="quiz-progress" class="h-full bg-gradient-to-r from-primary to-purple-500 transition-all duration-500 ease-out shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: ${progress}%"></div>
                    </div>

                    <!-- Main Content Body (Flex Column) -->
                    <div class="flex-1 w-full max-w-2xl mx-auto flex flex-col p-4 relative z-10 h-full overflow-hidden">
                        
                        <div id="quiz-watermark" class="fixed top-24 right-10 text-[180px] font-black text-white/[0.02] select-none pointer-events-none leading-none scale-150 origin-top-right">
                            ${currentIndex + 1}
                        </div>

                        <!-- Top Section: Question & Options (Scrollable) -->
                        <div class="flex-1 overflow-y-auto pr-2 thin-scroll flex flex-col justify-center min-h-0">
                            <div class="mb-6">
                                <p id="quiz-question-text" class="text-lg font-semibold text-white leading-relaxed tracking-tight drop-shadow-sm transition-opacity duration-200">${q.text}</p>
                            </div>

                            <div id="quiz-options-list" class="space-y-3">
                                ${q.options.map((opt, i) => {
                                    let baseClass = "w-full text-left p-4 rounded-xl option-card relative overflow-hidden flex items-center gap-3 text-slate-200 text-sm font-medium animate-slide-in-up";
                                    let statusClass = "hover:bg-slate-700/50 hover:border-white/10";
                                    let letterClass = "border-slate-500 text-slate-400";
                                    
                                    if (isAnswered) {
                                        if (i == q.correctIndex) { statusClass = "selected-correct"; letterClass = "border-emerald-400 text-emerald-400"; }
                                        else if (i == ans) { statusClass = "selected-wrong"; letterClass = "border-red-400 text-red-400"; }
                                        else statusClass = "disabled";
                                    }

                                    return `
                                    <button id="opt-btn-${i}" onclick="selectOption('${q.id}', ${i})" class="${baseClass} ${statusClass}" ${isAnswered ? 'disabled' : ''} style="animation-delay: ${i * 50}ms">
                                        <div class="opt-letter w-6 h-6 rounded-md border-2 ${letterClass} flex items-center justify-center text-[10px] font-bold transition-colors">
                                            ${String.fromCharCode(65+i)}
                                        </div>
                                        <span class="leading-snug">${opt}</span>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Bottom Section: Fixed Explanation Area (h-48) -->
                        <div id="quiz-explanation-container" class="h-48 shrink-0 mt-4 pt-2 relative border-t border-white/5">
                            ${isAnswered && q.explanation ? `
                                <div class="h-full overflow-y-auto thin-scroll slide-up bg-white/[0.02] p-4 rounded-xl border border-white/5">
                                    <div class="flex items-center gap-2 text-primary-hover text-[10px] font-bold uppercase tracking-widest mb-2 sticky top-0 bg-transparent backdrop-blur-sm">
                                        <span class="material-symbols-rounded text-sm">lightbulb</span> Açıklama
                                    </div>
                                    <p class="text-slate-300 text-sm leading-relaxed">${q.explanation}</p>
                                </div>
                            ` : '<div class="h-full flex items-center justify-center text-white/10 text-xs uppercase font-bold tracking-widest border border-white/5 rounded-xl border-dashed">Açıklama Alanı</div>'}
                        </div>
                    </div>
                </div>`;
        }

        // --- REVIEW PAGE ---
        function renderQuizReview(container) {
            const { test, questions, answers } = activeQuizData;
            let correctCount = 0;
            const reviewHtml = questions.map((q, idx) => {
                const userAns = answers[q.id];
                const isCorrect = userAns == q.correctIndex;
                if(isCorrect) correctCount++;
                return `
                <div class="glass-panel border ${isCorrect ? 'border-emerald-500/20 bg-emerald-500/5' : 'border-red-500/20 bg-red-500/5'} p-6 rounded-2xl relative overflow-hidden mb-5">
                    <div class="flex gap-4 mb-4">
                        <span class="text-slate-500 font-bold text-sm bg-black/20 px-2 py-1 h-fit rounded">#${idx+1}</span>
                        <p class="text-base text-white font-medium flex-1 leading-snug">${q.text}</p>
                    </div>
                    <div class="space-y-2 pl-0 md:pl-12">
                        ${q.options.map((opt, i) => {
                            let style = "text-slate-500";
                            let icon = "";
                            if (i === q.correctIndex) { style = "text-emerald-400 font-bold"; icon = "check"; }
                            else if (userAns == i && !isCorrect) { style = "text-red-400 font-medium line-through decoration-red-500/50"; }
                            return `<div class="text-xs ${style} flex items-center gap-2 bg-black/10 p-2 rounded-lg border border-transparent ${i===q.correctIndex ? 'border-emerald-500/20 bg-emerald-500/10' : ''}">${icon ? `<span class="material-symbols-rounded text-base">${icon}</span>` : '<span class="w-4"></span>'} ${opt}</div>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = `
                <div class="fade-in max-w-3xl mx-auto w-full pb-10 pt-4 px-4">
                    <div class="flex flex-col items-center justify-center py-12 text-center glass-panel rounded-3xl mb-8 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary to-purple-600"></div>
                        <div class="w-32 h-32 rounded-full border-8 border-slate-800 flex items-center justify-center text-4xl font-black text-white mb-6 shadow-2xl relative z-10" 
                             style="background: conic-gradient(${correctCount/questions.length > 0.5 ? '#10b981' : '#f43f5e'} ${Math.round((correctCount/questions.length)*100)}%, #1e293b 0);">
                            %${Math.round((correctCount/questions.length)*100)}
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-1">${test.title}</h2>
                        <p class="text-slate-400 text-sm font-medium mb-6 uppercase tracking-wide">Test Sonucu</p>
                        
                        <div class="flex gap-8 text-center mb-8">
                            <div><p class="text-2xl font-bold text-white">${correctCount}</p><p class="text-[10px] text-slate-500 uppercase font-bold">Doğru</p></div>
                            <div><p class="text-2xl font-bold text-white">${questions.length - correctCount}</p><p class="text-[10px] text-slate-500 uppercase font-bold">Yanlış</p></div>
                            <div><p class="text-2xl font-bold text-white">${questions.length}</p><p class="text-[10px] text-slate-500 uppercase font-bold">Toplam</p></div>
                        </div>

                        <button onclick="router('content')" class="bg-white text-slate-900 hover:bg-slate-200 px-8 py-3 rounded-2xl font-bold text-sm transition-all shadow-lg hover:scale-105 active:scale-95">Listeye Dön</button>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5 px-2">Detaylı Cevaplar</h3>
                        ${reviewHtml}
                    </div>
                </div>`;
        }

        // --- Modals & Data Handling ---
        window.openModal = (type, id = null, subId = null) => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            overlay.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
            
            currentEditingId = type === 'subcategory' ? subId : id;

            if (type === 'global-test-json') {
                title.innerText = id ? 'Testi Düzenle' : 'Yeni Test';
                let selCat = contentFilter.catId !== 'all' ? contentFilter.catId : '';
                let selSub = contentFilter.subId !== 'all' ? contentFilter.subId : '';
                let testData = null;
                let jsonContent = '[]';
                
                if (id) {
                    testData = tests.find(t => t.id === id);
                    if (testData) {
                        const sub = subcategories.find(s => s.id === testData.subId);
                        if (sub) { selSub = sub.id; selCat = sub.catId; }
                        const tQs = questions.filter(q => q.testId === id).map(q => ({ text: q.text, options: q.options, correctIndex: q.correctIndex, explanation: q.explanation || "" }));
                        jsonContent = JSON.stringify(tQs, null, 2);
                    }
                }
                const catOpts = categories.map(c => `<option value="${c.id}" ${c.id === selCat ? 'selected' : ''}>${c.name}</option>`).join('');
                
                body.innerHTML = `
                    <form onsubmit="handleSubmit(event, 'global-test-json')" class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1.5 ml-1">Kategori</label><select id="modal-cat-select" onchange="filterSubcatsInModal()" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-white text-xs outline-none focus:border-primary transition-colors"><option value="">Seçiniz</option>${catOpts}</select></div>
                            <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1.5 ml-1">Alt Kategori</label><select name="subId" id="modal-sub-select" required class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-white text-xs outline-none focus:border-primary transition-colors disabled:opacity-50"><option value="">Önce kategori...</option></select></div>
                        </div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1.5 ml-1">Başlık</label><input name="title" value="${testData?.title || ''}" required class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-white text-sm outline-none focus:border-primary transition-colors placeholder:text-slate-600" placeholder="Örn: Tarih Deneme 1"></div>
                        <div>
                            <div class="flex justify-between items-center mb-1.5 ml-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Sorular (JSON)</label>
                                <span class="text-[10px] text-primary cursor-pointer hover:underline" onclick="copyExampleJson()">Örnek Kopyala</span>
                            </div>
                            <textarea name="questionsJson" rows="8" required class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-slate-300 font-mono text-[11px] outline-none focus:border-primary transition-colors resize-none">${jsonContent}</textarea>
                        </div>
                        <button class="w-full bg-primary hover:bg-primary-hover text-white py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all">${id ? 'Güncelle' : 'Testi Oluştur'}</button>
                    </form>`;
                setTimeout(() => filterSubcatsInModal(selSub), 100);

            } else if (type === 'category') {
                title.innerText = 'Kategori Yönetimi';
                body.innerHTML = `<form onsubmit="handleSubmit(event, 'category')" class="space-y-4"><div><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1.5 ml-1">Kategori Adı</label><input name="name" required class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-white text-sm outline-none focus:border-primary"></div><button class="w-full bg-primary hover:bg-primary-hover text-white py-3 rounded-xl font-bold text-sm shadow-lg">Kaydet</button></form>`;
            } else if (type === 'subcategory') {
                title.innerText = 'Alt Kategori Ekle';
                body.innerHTML = `<form onsubmit="handleSubmit(event, 'subcategory')" class="space-y-4"><input type="hidden" name="catId" value="${id}"><div><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1.5 ml-1">Alt Kategori Adı</label><input name="name" required class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-white text-sm outline-none focus:border-primary"></div><button class="w-full bg-primary hover:bg-primary-hover text-white py-3 rounded-xl font-bold text-sm shadow-lg">Kaydet</button></form>`;
            }
        }

        window.filterSubcatsInModal = (preSelectId = null) => {
            const catId = document.getElementById('modal-cat-select').value;
            const subSel = document.getElementById('modal-sub-select');
            if (!catId) { subSel.innerHTML = '<option value="">Önce kategori...</option>'; subSel.disabled = true; return; }
            const subs = subcategories.filter(s => s.catId === catId);
            subSel.innerHTML = subs.length ? subs.map(s => `<option value="${s.id}" ${s.id === preSelectId ? 'selected' : ''}>${s.name}</option>`).join('') : '<option value="">Yok</option>';
            subSel.disabled = !subs.length;
        }
        
        window.copyExampleJson = () => {
            const ex = `[
  {
    "text": "Soru metni buraya",
    "options": ["A Seçeneği", "B Seçeneği", "C Seçeneği", "D Seçeneği", "E Seçeneği"],
    "correctIndex": 0,
    "explanation": "Açıklama metni buraya."
  }
]`;
            navigator.clipboard.writeText(ex);
            showToast("Kopyalandı");
        }

        window.closeModal = () => { document.getElementById('modal-overlay').classList.add('hidden'); }

        window.handleSubmit = async (e, type) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "..."; btn.disabled = true;
            const fd = new FormData(e.target);
            const d = Object.fromEntries(fd.entries());
            const path = `artifacts/${appId}/users/${currentUser.uid}`;

            try {
                if (type === 'category') {
                     await addDoc(collection(db, path, 'categories'), { name: d.name, createdAt: Date.now() });
                } else if (type === 'subcategory') {
                     await addDoc(collection(db, path, 'subcategories'), { name: d.name, catId: d.catId, createdAt: Date.now() });
                } else if (type === 'global-test-json') {
                    const qs = JSON.parse(d.questionsJson);
                    if (currentEditingId) {
                        await updateDoc(doc(db, path, 'tests', currentEditingId), { title: d.title, subId: d.subId, questionCount: qs.length });
                        const oldQs = questions.filter(q => q.testId === currentEditingId);
                        oldQs.forEach(async q => await deleteDoc(doc(db, path, 'questions', q.id)));
                        await Promise.all(qs.map(q => addDoc(collection(db, path, 'questions'), { ...q, testId: currentEditingId })));
                    } else {
                        const ref = await addDoc(collection(db, path, 'tests'), { title: d.title, subId: d.subId, questionCount: qs.length, createdAt: Date.now() });
                        await Promise.all(qs.map(q => addDoc(collection(db, path, 'questions'), { ...q, testId: ref.id })));
                    }
                }
                closeModal();
                showToast("Başarılı");
            } catch(err) { showToast("Hata oluştu: " + err.message, "error"); console.error(err); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        }

        window.deleteItem = async (col, id) => {
            if(!confirm("Silmek istiyor musun?")) return;
            await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}`, col, id));
            showToast("Silindi");
        }

        window.showToast = (title, type = "success") => {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = title;
            t.className = `fixed bottom-6 right-6 px-5 py-4 rounded-2xl shadow-2xl transform transition-all duration-300 z-[80] flex items-center gap-3 text-sm font-bold border backdrop-blur-md ${type === 'error' ? 'bg-red-900/80 border-red-500/50 text-red-100' : 'bg-slate-900/80 border-emerald-500/50 text-emerald-400'}`;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        init();
    </script>
</body>
</html>