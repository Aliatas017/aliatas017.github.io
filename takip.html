<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBRyvBSrNc5QKFWiMryYbHG-s4DXf4IIrc",
    authDomain: "kpss-takip-75477.firebaseapp.com",
    projectId: "kpss-takip-75477",
    storageBucket: "kpss-takip-75477.firebasestorage.app",
    messagingSenderId: "1083935832054",
    appId: "1:1083935832054:web:d02f57e3721e39f286b9d7",
    measurementId: "G-QFLEBQEHBC"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Kütüphanem V6 (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        body.not-logged-in .auth-protected { display: none !important; }
        .sub-menu { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        .sub-menu.open { max-height: 500px; opacity: 1; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', text: '#e2e8f0', muted: '#94a3b8' } } } } }
    </script>
</head>
<body class="bg-dark-900 text-dark-text font-sans h-screen flex overflow-hidden selection:bg-blue-500 selection:text-white not-logged-in">

    <!-- SETUP & LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 z-[60] bg-dark-900 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-sm bg-dark-800 border border-dark-700 p-8 rounded-2xl shadow-2xl relative">
            
            <!-- Config Warning -->
            <div id="configWarning" class="hidden absolute -top-16 left-0 right-0 bg-red-500/10 border border-red-500/50 text-red-200 p-3 rounded-xl text-xs text-center">
                Firebase Ayarları Yapılmamış! <br> Lütfen kodu düzenleyip <code>firebaseConfig</code> alanını doldurun.
            </div>

            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg shadow-blue-900/50">
                    <i data-lucide="cloud" class="w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Bulut Kütüphane</h1>
                <p class="text-dark-muted text-sm mt-2">Her yerden erişilebilir, senkronize.</p>
            </div>

            <form id="authForm" class="space-y-4">
                <div id="authError" class="hidden bg-red-500/10 text-red-400 text-xs p-3 rounded-lg border border-red-500/20"></div>
                
                <div>
                    <label class="block text-xs font-bold text-dark-muted mb-1 uppercase">E-Posta</label>
                    <input type="email" id="email" placeholder="ornek@mail.com" class="w-full px-4 py-2.5 bg-dark-900 border border-dark-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-white">
                </div>
                <div>
                    <label class="block text-xs font-bold text-dark-muted mb-1 uppercase">Şifre</label>
                    <input type="password" id="password" placeholder="******" class="w-full px-4 py-2.5 bg-dark-900 border border-dark-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-white">
                </div>

                <button type="submit" id="loginBtn" class="w-full py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg transition-all flex justify-center items-center gap-2">
                    <span>Giriş Yap / Kayıt Ol</span>
                </button>
                <p class="text-[10px] text-center text-dark-muted mt-2">Hesabınız yoksa otomatik oluşturulur.</p>
            </form>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-72 bg-dark-800 border-r border-dark-700 flex flex-col transition-transform duration-300 fixed md:relative z-30 h-full -translate-x-full md:translate-x-0">
        <div class="p-6 border-b border-dark-700 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-900/50">
                    <i data-lucide="library" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight leading-none">Kütüphane</h1>
                    <span class="text-[10px] uppercase font-bold text-emerald-400 bg-emerald-500/10 px-1.5 py-0.5 rounded">Online</span>
                </div>
            </div>
            <button id="closeSidebar" class="md:hidden text-dark-muted"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <div class="p-4 auth-protected">
            <button onclick="openModal()" class="w-full bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-900/20 active:scale-95 group">
                <i data-lucide="plus" class="w-5 h-5 group-hover:rotate-90 transition-transform"></i>
                <span>Yeni Link Ekle</span>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto px-4 pb-4 auth-protected">
            <div class="text-xs font-bold text-dark-muted uppercase mb-3 px-2 tracking-wider flex justify-between items-center"><span>Konular</span></div>
            <ul id="categoryList" class="space-y-2"></ul>
            <button onclick="openCatModal('main')" class="mt-6 w-full flex items-center gap-2 px-3 py-2 text-sm text-dark-muted hover:text-blue-400 hover:bg-dark-700/50 rounded-lg border border-dashed border-dark-700 hover:border-blue-500/50 transition-all group">
                <i data-lucide="folder-plus" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> <span>Ana Kategori Ekle</span>
            </button>
        </nav>

        <div class="p-4 border-t border-dark-700 bg-dark-800/50 flex justify-between items-center auth-protected">
            <button onclick="handleLogout()" class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1"><i data-lucide="log-out" class="w-3 h-3"></i> Çıkış</button>
            <div class="text-[10px] text-dark-muted" id="userEmailDisplay"></div>
        </div>
    </aside>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/60 z-20 hidden md:hidden glass"></div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <header class="h-16 bg-dark-800/95 backdrop-blur border-b border-dark-700 flex items-center justify-between px-4 md:px-8 z-10">
            <div class="flex items-center gap-4">
                <button id="openSidebar" class="md:hidden p-2 hover:bg-dark-700 rounded-lg text-dark-text"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <div>
                    <h2 id="pageTitle" class="text-lg font-semibold text-white hidden md:block">Tüm Kayıtlar</h2>
                    <div class="flex items-center gap-2 text-xs text-dark-muted">
                         <span id="breadcrumbMain">Kütüphane</span><i data-lucide="chevron-right" class="w-3 h-3"></i><span id="breadcrumbSub" class="text-blue-400">Genel</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4 flex-1 justify-end md:flex-none">
                <div class="relative w-full max-w-xs group">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-dark-muted w-4 h-4 group-focus-within:text-blue-400 transition-colors"></i>
                    <input type="text" id="searchInput" placeholder="Ara..." class="w-full pl-10 pr-4 py-2 bg-dark-900 border border-dark-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm text-white transition-all">
                </div>
            </div>
        </header>

        <div class="bg-dark-900 px-4 md:px-8 py-4 border-b border-dark-700/50 auth-protected">
            <div class="flex gap-4 overflow-x-auto pb-2 scrollbar-hide">
                 <div class="flex-1 flex items-center gap-4 bg-dark-800 px-4 py-3 rounded-xl border border-dark-700 max-w-md">
                    <div class="flex-1">
                        <div class="flex justify-between mb-1"><span class="text-[10px] text-dark-muted font-bold uppercase tracking-widest">Kategori İlerlemesi</span><span id="progressText" class="text-xs font-bold text-blue-400">0%</span></div>
                        <div class="w-full h-2 bg-dark-900 rounded-full overflow-hidden"><div id="statProgressBar" class="h-full bg-blue-500 transition-all duration-700 w-0"></div></div>
                    </div>
                    <div class="text-right border-l border-dark-700 pl-4"><span id="statCompleted" class="text-lg font-bold text-white block leading-none">0</span><span class="text-[9px] text-dark-muted uppercase">Tamamlandı</span></div>
                </div>
            </div>
        </div>
        <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth auth-protected">
             <!-- Loader initially -->
             <div class="flex justify-center items-center h-full"><div class="loader"></div></div>
        </div>
    </main>

    <!-- MODALS -->
    <!-- Content Modal -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal()"></div><div class="bg-dark-800 border border-dark-700 rounded-2xl shadow-2xl w-full max-w-md relative z-10 transform transition-all scale-100"><div class="px-6 py-4 border-b border-dark-700 flex justify-between items-center bg-dark-800/50 rounded-t-2xl"><h3 id="modalTitle" class="font-bold text-lg text-white">İçerik Ekle</h3><button onclick="closeModal()" class="text-dark-muted hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div><form id="itemForm" class="p-6 space-y-4"><input type="hidden" id="editItemId"><div><label class="block text-xs font-bold text-dark-muted mb-1 uppercase">Başlık</label><input type="text" id="inputTitle" required class="w-full px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-white focus:border-blue-500 outline-none"></div><div><label class="block text-xs font-bold text-dark-muted mb-1 uppercase">Link</label><input type="url" id="inputUrl" required class="w-full px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-white focus:border-blue-500 outline-none"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-dark-muted mb-1 uppercase">Ana Kategori</label><select id="inputMainCategory" onchange="populateSubSelect(this.value)" class="w-full px-3 py-2 bg-dark-900 border border-dark-700 rounded-lg text-white outline-none text-sm"></select></div><div><label class="block text-xs font-bold text-dark-muted mb-1 uppercase">Alt Kategori</label><select id="inputSubCategory" class="w-full px-3 py-2 bg-dark-900 border border-dark-700 rounded-lg text-white outline-none text-sm"></select></div></div><div><label class="block text-xs font-bold text-dark-muted mb-1 uppercase">Not</label><textarea id="inputNote" rows="2" class="w-full px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-white focus:border-blue-500 outline-none resize-none"></textarea></div><div class="pt-2 flex gap-3"><button type="button" onclick="closeModal()" class="flex-1 py-2 border border-dark-700 text-dark-muted rounded-lg hover:bg-dark-700">İptal</button><button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 shadow-lg">Kaydet</button></div></form></div></div>
    <!-- Category Modal -->
    <div id="catModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeCatModal()"></div><div class="bg-dark-800 border border-dark-700 rounded-2xl shadow-2xl w-full max-w-sm relative z-10 transform transition-all scale-100"><div class="px-6 py-4 border-b border-dark-700 flex justify-between items-center bg-dark-800/50 rounded-t-2xl"><h3 id="catModalTitle" class="font-bold text-lg text-white">Kategori Ekle</h3><button onclick="closeCatModal()" class="text-dark-muted hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div><form id="catForm" class="p-6 space-y-4"><input type="hidden" id="catType"><input type="hidden" id="parentCatId"><div><label class="block text-xs font-bold text-dark-muted mb-1 uppercase">Kategori Adı</label><input type="text" id="catNameInput" required placeholder="Örn: Vatandaşlık" class="w-full px-4 py-2.5 bg-dark-900 border border-dark-700 rounded-xl text-white focus:border-blue-500 outline-none"></div><div class="pt-2 flex gap-3"><button type="button" onclick="closeCatModal()" class="flex-1 py-2 border border-dark-700 text-dark-muted rounded-lg hover:bg-dark-700">İptal</button><button type="submit" class="flex-1 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-500 shadow-lg">Oluştur</button></div></form></div></div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        // -------------------------------------------------------------
        // BURAYI DÜZENLEYİN: Firebase Konsolundan Alınan Kodu Yapıştırın
        // -------------------------------------------------------------
        const firebaseConfig = {
            // Örnek:
            // apiKey: "AIzaSyD...",
            // authDomain: "proje-id.firebaseapp.com",
            // projectId: "proje-id",
            // storageBucket: "proje-id.appspot.com",
            // messagingSenderId: "...",
            // appId: "..."
        };
        // -------------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let app, auth, db;
        let categories = [];
        let items = [];
        let activeMainId = 'all';
        let activeSubId = null;
        let currentUser = null;

        // Initialize Firebase
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('configWarning').classList.remove('hidden');
                throw new Error("Config Missing");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Hatası:", e);
        }

        // --- AUTH ---
        const loginOverlay = document.getElementById('loginOverlay');
        const authForm = document.getElementById('authForm');
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.body.classList.remove('not-logged-in');
                loginOverlay.classList.add('hidden');
                document.getElementById('userEmailDisplay').textContent = user.email;
                initDataListener();
            } else {
                currentUser = null;
                document.body.classList.add('not-logged-in');
                loginOverlay.classList.remove('hidden');
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            const errDiv = document.getElementById('authError');
            
            btn.innerHTML = '<div class="loader"></div>';
            errDiv.classList.add('hidden');

            try {
                // Try Login
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') {
                    // If login fails, try Register (Simple logic for single user experience)
                    try {
                        await createUserWithEmailAndPassword(auth, email, pass);
                        // Setup default categories for new user
                        await createDefaultCategories();
                    } catch (regError) {
                        errDiv.textContent = "Giriş/Kayıt Hatası: " + regError.message;
                        errDiv.classList.remove('hidden');
                    }
                } else {
                    errDiv.textContent = "Hata: " + error.message;
                    errDiv.classList.remove('hidden');
                }
            }
            btn.innerHTML = '<span>Giriş Yap / Kayıt Ol</span>';
        });

        window.handleLogout = () => signOut(auth);

        // --- DATA SYNC (REALTIME) ---
        function initDataListener() {
            if(!currentUser) return;
            
            // Listen Categories
            const qCat = query(collection(db, 'categories'));
            onSnapshot(qCat, (snapshot) => {
                categories = snapshot.docs.map(d => ({...d.data(), id: d.id}));
                // Sort categories manually if needed, or rely on added order
                renderCategories();
            });

            // Listen Items
            const qItem = query(collection(db, 'items'), orderBy('createdAt', 'desc'));
            onSnapshot(qItem, (snapshot) => {
                items = snapshot.docs.map(d => ({...d.data(), id: d.id}));
                renderItems();
                updateStats();
            });
        }

        async function createDefaultCategories() {
            const defaults = [
                { name: 'Tarih', icon: 'scroll', subs: [{ id: 'osmanli', name: 'Osmanlı' }] },
                { name: 'Matematik', icon: 'calculator', subs: [{ id: 'mat1', name: 'Matematik 1' }] }
            ];
            for(const c of defaults) {
                await addDoc(collection(db, 'categories'), c);
            }
        }

        // --- RENDERING (Same UI Logic) ---
        function renderCategories() {
            const listEl = document.getElementById('categoryList'); listEl.innerHTML = '';
            const allActive = activeMainId === 'all';
            
            listEl.innerHTML += `<li><button onclick="window.selectCategory('all')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-all ${allActive ? 'bg-blue-600 text-white' : 'text-dark-muted hover:bg-dark-700 hover:text-white'}"><i data-lucide="layers" class="w-4 h-4"></i><span class="font-medium">Tüm Kayıtlar</span></button></li>`;

            categories.forEach(cat => {
                const isActiveMain = activeMainId === cat.id;
                const subMenuId = `sub-${cat.id}`;
                const subs = cat.subs || [];
                const li = document.createElement('li');
                
                li.innerHTML = `
                    <div class="group relative">
                        <div class="flex items-center gap-1">
                            <button onclick="window.toggleSubMenu('${cat.id}')" class="flex-1 flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-all ${isActiveMain ? 'bg-dark-700 text-white' : 'text-dark-muted hover:bg-dark-700 hover:text-white'}">
                                <i data-lucide="${cat.icon || 'folder'}" class="w-4 h-4"></i><span class="flex-1 text-left font-medium">${cat.name}</span><i data-lucide="${isActiveMain ? 'chevron-down' : 'chevron-right'}" class="w-3 h-3 transition-transform"></i>
                            </button>
                            <div class="flex flex-col gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 top-1/2 -translate-y-1/2">
                                <button onclick="window.openCatModal('sub', '${cat.id}')" class="p-1 bg-dark-900 text-blue-400 hover:text-white rounded shadow" title="Alt Kategori Ekle"><i data-lucide="plus" class="w-3 h-3"></i></button>
                                <button onclick="window.deleteMainCategory('${cat.id}')" class="p-1 bg-dark-900 text-red-400 hover:text-white rounded shadow" title="Sil"><i data-lucide="trash" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                    </div>
                    <ul id="${subMenuId}" class="sub-menu ${isActiveMain ? 'open' : ''} pl-9 pr-2 space-y-1 mt-1 border-l border-dark-700 ml-4">
                        ${subs.map(sub => {
                            const isSubActive = activeSubId === sub.id;
                            const count = items.filter(i => i.subId === sub.id).length;
                            return `<li class="relative group/sub">
                                <button onclick="window.selectCategory('${cat.id}', '${sub.id}')" class="w-full flex items-center justify-between text-xs py-2 px-3 rounded-lg transition-colors ${isSubActive ? 'bg-blue-500/10 text-blue-400 font-bold' : 'text-dark-muted hover:text-white hover:bg-dark-700/50'}">
                                    <span>${sub.name}</span><span class="text-[9px] bg-dark-900 px-1.5 rounded opacity-50">${count}</span>
                                </button>
                                <button onclick="window.deleteSubCategory('${cat.id}', '${sub.id}')" class="absolute right-8 top-1/2 -translate-y-1/2 p-1 text-red-500 opacity-0 group-hover/sub:opacity-100 hover:bg-dark-900 rounded"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </li>`
                        }).join('')}
                    </ul>`;
                listEl.appendChild(li);
            });
            lucide.createIcons();
        }

        function renderItems() {
            const container = document.getElementById('contentArea');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            
            const mainCat = categories.find(c => c.id === activeMainId);
            const subCat = mainCat?.subs?.find(s => s.id === activeSubId);
            
            document.getElementById('breadcrumbMain').textContent = mainCat ? mainCat.name : 'Tüm Kayıtlar';
            document.getElementById('breadcrumbSub').textContent = subCat ? subCat.name : (activeMainId === 'all' ? '' : 'Tümü');
            document.getElementById('pageTitle').textContent = subCat ? subCat.name : (mainCat ? mainCat.name : 'Tüm Kayıtlar');

            const filtered = items.filter(item => {
                const matchesMain = activeMainId === 'all' || item.mainId === activeMainId;
                const matchesSub = !activeSubId || item.subId === activeSubId;
                const matchesSearch = item.title.toLowerCase().includes(searchVal) || (item.note && item.note.toLowerCase().includes(searchVal));
                return matchesMain && matchesSub && matchesSearch;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-dark-muted opacity-50"><i data-lucide="cloud-off" class="w-16 h-16 mb-4"></i><p>Kayıt bulunamadı.</p><button onclick="window.openModal()" class="mt-2 text-blue-400 hover:underline">Yeni Ekle</button></div>`;
                lucide.createIcons(); return;
            }

            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                ${filtered.map(item => {
                    const isDone = item.status === 'completed';
                    const mCat = categories.find(c => c.id === item.mainId);
                    const sCat = mCat?.subs?.find(s => s.id === item.subId);
                    return `
                    <div class="bg-dark-800 border ${isDone ? 'border-emerald-500/20' : 'border-dark-700'} rounded-xl p-4 hover:border-dark-600 transition-all group relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] uppercase font-bold text-dark-muted bg-dark-900 px-2 py-1 rounded">${mCat?.name || '?'} / ${sCat?.name || '?'}</span>
                            <div class="flex gap-2"><button onclick="window.openModal('${item.id}')" class="text-dark-muted hover:text-blue-400"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button><span class="text-[10px] text-dark-muted">${item.date || ''}</span></div>
                        </div>
                        <h3 class="font-bold text-white mb-2 line-clamp-2 ${isDone ? 'line-through text-dark-muted' : ''}">${item.title}</h3>
                        ${item.note ? `<p class="text-xs text-dark-muted bg-dark-900/50 p-2 rounded mb-3 line-clamp-2">${item.note}</p>` : ''}
                        <div class="flex gap-2 mt-auto pt-2 border-t border-dark-700/50">
                            <button onclick="window.toggleItemStatus('${item.id}', '${item.status}')" class="flex-1 flex items-center justify-center gap-2 py-1.5 rounded text-xs font-bold uppercase ${isDone ? 'bg-orange-500/10 text-orange-400' : 'bg-emerald-500/10 text-emerald-400'}"><i data-lucide="${isDone ? 'rotate-ccw' : 'check'}" class="w-3 h-3"></i>${isDone ? 'Geri Al' : 'Bitir'}</button>
                            <a href="${item.url}" target="_blank" class="px-3 flex items-center justify-center bg-blue-500/10 text-blue-400 rounded hover:bg-blue-500/20"><i data-lucide="external-link" class="w-4 h-4"></i></a>
                            <button onclick="window.deleteItem('${item.id}')" class="px-3 text-red-400 bg-red-500/10 rounded hover:bg-red-500/20"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`
                }).join('')}
            </div>`;
            lucide.createIcons();
        }

        function updateStats() {
            let filtered = items;
            if(activeMainId !== 'all') filtered = filtered.filter(i => i.mainId === activeMainId);
            if(activeSubId) filtered = filtered.filter(i => i.subId === activeSubId);
            const completed = filtered.filter(i => i.status === 'completed').length;
            const total = filtered.length;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            document.getElementById('statCompleted').textContent = completed + '/' + total;
            document.getElementById('progressText').textContent = `%${percent}`;
            document.getElementById('statProgressBar').style.width = `${percent}%`;
            document.getElementById('statProgressBar').className = `h-full transition-all duration-700 ${percent === 100 ? 'bg-emerald-500' : 'bg-blue-500'}`;
        }

        // --- GLOBAL ACTIONS (Window Scope) ---
        window.selectCategory = (mId, sId = null) => { activeMainId = mId; activeSubId = sId; renderCategories(); renderItems(); updateStats(); if(window.innerWidth < 768) window.toggleSidebar(false); };
        window.toggleSubMenu = (catId) => { activeMainId = (activeMainId === catId) ? 'all' : catId; activeSubId = null; renderCategories(); renderItems(); };
        window.toggleSidebar = (show) => { 
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            show ? (sb.classList.remove('-translate-x-full'), ov.classList.remove('hidden')) : (sb.classList.add('-translate-x-full'), ov.classList.add('hidden'));
        };

        // --- CRUD ACTIONS (Firebase) ---
        window.toggleItemStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'pending' ? 'completed' : 'pending';
            await updateDoc(doc(db, 'items', id), { status: newStatus });
        };

        window.deleteItem = async (id) => {
            if(confirm('Silmek istediğine emin misin?')) await deleteDoc(doc(db, 'items', id));
        };

        // MODAL LOGIC
        window.openModal = (editId = null) => {
            const modal = document.getElementById('modal');
            const mainSelect = document.getElementById('inputMainCategory');
            mainSelect.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            if (editId) {
                document.getElementById('modalTitle').textContent = "Düzenle";
                const item = items.find(i => i.id === editId);
                document.getElementById('editItemId').value = item.id;
                document.getElementById('inputTitle').value = item.title;
                document.getElementById('inputUrl').value = item.url;
                document.getElementById('inputNote').value = item.note || '';
                mainSelect.value = item.mainId;
                window.populateSubSelect(item.mainId);
                document.getElementById('inputSubCategory').value = item.subId;
            } else {
                document.getElementById('modalTitle').textContent = "Yeni Ekle";
                document.getElementById('itemForm').reset();
                document.getElementById('editItemId').value = '';
                if(activeMainId !== 'all') { mainSelect.value = activeMainId; window.populateSubSelect(activeMainId); if(activeSubId) document.getElementById('inputSubCategory').value = activeSubId; }
                else { window.populateSubSelect(categories[0]?.id || ''); }
            }
            modal.classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');
        
        window.populateSubSelect = (mainId) => {
            const subSelect = document.getElementById('inputSubCategory'); subSelect.innerHTML = '';
            const mainCat = categories.find(c => c.id === mainId);
            if(mainCat && mainCat.subs) { mainCat.subs.forEach(s => { subSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`; }); }
        };

        // ITEM FORM SUBMIT
        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editItemId').value;
            const title = document.getElementById('inputTitle').value;
            const url = document.getElementById('inputUrl').value;
            const mainId = document.getElementById('inputMainCategory').value;
            const subId = document.getElementById('inputSubCategory').value;
            const note = document.getElementById('inputNote').value;

            const payload = { title, url, mainId, subId, note };

            if (editId) {
                await updateDoc(doc(db, 'items', editId), payload);
            } else {
                await addDoc(collection(db, 'items'), {
                    ...payload,
                    status: 'pending',
                    createdAt: Date.now(),
                    date: new Date().toLocaleDateString('tr-TR')
                });
            }
            window.closeModal();
        });

        // CATEGORY ACTIONS
        window.openCatModal = (type, parentId = null) => {
            document.getElementById('catModal').classList.remove('hidden');
            document.getElementById('catType').value = type;
            document.getElementById('parentCatId').value = parentId || '';
            document.getElementById('catNameInput').value = '';
            document.getElementById('catModalTitle').textContent = type === 'main' ? "Ana Kategori Ekle" : "Alt Kategori Ekle";
        };
        window.closeCatModal = () => document.getElementById('catModal').classList.add('hidden');

        document.getElementById('catForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('catNameInput').value;
            const type = document.getElementById('catType').value;
            const parentId = document.getElementById('parentCatId').value;
            
            if(type === 'main') {
                await addDoc(collection(db, 'categories'), { name, icon: 'folder', subs: [] });
            } else {
                const cat = categories.find(c => c.id === parentId);
                const newSubs = [...(cat.subs || []), { id: Date.now().toString(), name }];
                await updateDoc(doc(db, 'categories', parentId), { subs: newSubs });
                activeMainId = parentId;
            }
            window.closeCatModal();
        });

        window.deleteMainCategory = async (id) => {
            if(!confirm("Kategori silinecek!")) return;
            await deleteDoc(doc(db, 'categories', id));
            // Note: In real production, you'd perform a batch delete of items too.
            if(activeMainId === id) activeMainId = 'all';
        };

        window.deleteSubCategory = async (mainId, subId) => {
            if(!confirm("Alt kategori silinecek!")) return;
            const cat = categories.find(c => c.id === mainId);
            const newSubs = cat.subs.filter(s => s.id !== subId);
            await updateDoc(doc(db, 'categories', mainId), { subs: newSubs });
        };

        // Event Listeners for UI
        document.getElementById('searchInput').addEventListener('input', renderItems);
        document.getElementById('openSidebar').addEventListener('click', () => window.toggleSidebar(true));
        document.getElementById('closeSidebar').addEventListener('click', () => window.toggleSidebar(false));
        document.getElementById('sidebarOverlay').addEventListener('click', () => window.toggleSidebar(false));

        // Init Icons
        lucide.createIcons();
    </script>
</body>
</html>
