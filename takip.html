<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Mobil Kütüphane V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        .sheet-transition { transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1); }
        .sheet-open { transform: translateY(0); }
        .sheet-closed { transform: translateY(100%); }

        .viewer-transition { transition: transform 0.25s ease-in-out, opacity 0.25s ease; }
        .viewer-open { transform: scale(1); opacity: 1; pointer-events: auto; }
        .viewer-closed { transform: scale(0.95); opacity: 0; pointer-events: none; }

        .cat-active { background: #6366f1; color: white; border-color: #6366f1; }
    </style>
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    colors: { 
                        dark: { 950: '#09090b', 900: '#121215', 800: '#1c1c21', 700: '#27272a' } 
                    }
                } 
            } 
        }
    </script>
</head>
<body class="bg-dark-950 text-gray-200 h-[100dvh] flex flex-col overflow-hidden relative">

    <!-- HEADER -->
    <header class="flex-none px-5 pt-6 pb-2 bg-dark-950 z-20">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-tr from-indigo-600 to-violet-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
                    <i data-lucide="library" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white leading-none tracking-tight">Kütüphanem</h1>
                    <span class="text-[10px] font-medium text-gray-500 uppercase tracking-widest">Mobil Pro</span>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2.5 bg-dark-800 rounded-full text-gray-400 hover:text-white border border-dark-700 active:scale-95 transition-transform">
                <i data-lucide="settings-2" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- SEARCH -->
        <div class="relative group">
            <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 group-focus-within:text-indigo-500 transition-colors"></i>
            <input type="text" id="searchInput" placeholder="Notlarda ara..." class="w-full bg-dark-900 border border-dark-700 rounded-2xl py-3.5 pl-10 pr-4 text-sm text-white placeholder-gray-600 focus:border-indigo-500 focus:outline-none transition-all focus:bg-dark-800">
        </div>
    </header>

    <!-- CATEGORY TABS -->
    <div class="flex-none px-4 py-3 border-b border-dark-800/50 bg-dark-950/95 backdrop-blur z-10">
        <div id="categoryList" class="flex gap-2.5 overflow-x-auto hide-scroll pb-1">
            <!-- JS populates here -->
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main id="contentArea" class="flex-1 overflow-y-auto p-4 space-y-3 pb-28 scroll-smooth">
        <!-- JS populates items here -->
    </main>

    <!-- FAB (Add Button) -->
    <div class="fixed bottom-6 right-6 z-30">
        <button onclick="openModal()" class="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-indigo-600/40 active:scale-90 transition-transform border-2 border-dark-950">
            <i data-lucide="plus" class="w-7 h-7"></i>
        </button>
    </div>

    <!-- === DETAIL VIEW (LAUNCHPAD) === -->
    <!-- iframe yerine bu ekran açılacak -->
    <div id="detailView" class="fixed inset-0 z-[60] bg-dark-950/95 backdrop-blur-xl viewer-closed viewer-transition flex flex-col items-center justify-center p-6">
        
        <!-- Close Button -->
        <button onclick="closeDetail()" class="absolute top-6 right-6 p-2 bg-dark-800 rounded-full text-gray-400 hover:text-white border border-dark-700 active:scale-90 transition-transform">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>

        <!-- Card Content -->
        <div class="w-full max-w-sm bg-dark-900 border border-dark-700 p-6 rounded-3xl shadow-2xl relative overflow-hidden">
            <!-- Background Glow -->
            <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
            
            <div class="relative z-10 text-center flex flex-col items-center">
                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg mb-5">
                    <i data-lucide="link" class="w-8 h-8"></i>
                </div>
                
                <span id="detailCategory" class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest bg-indigo-500/10 px-3 py-1 rounded-full mb-3">KATEGORİ</span>
                
                <h2 id="detailTitle" class="text-xl font-bold text-white mb-4 leading-tight">Başlık Buraya</h2>
                
                <div id="detailNoteBox" class="w-full bg-dark-800/50 rounded-xl p-4 border border-dark-700/50 text-left mb-6">
                    <p class="text-xs text-gray-500 uppercase font-bold mb-1 flex items-center gap-1"><i data-lucide="sticky-note" class="w-3 h-3"></i> Notlar</p>
                    <p id="detailNote" class="text-sm text-gray-300 italic">Not yok...</p>
                </div>

                <!-- Launch Button -->
                <a id="detailLinkBtn" href="#" target="_blank" onclick="closeDetail()" class="w-full py-4 bg-white text-black font-bold rounded-xl flex items-center justify-center gap-2 shadow-xl active:scale-95 transition-transform hover:bg-gray-200">
                    <span>Canvas'ı Başlat</span>
                    <i data-lucide="external-link" class="w-4 h-4"></i>
                </a>
                
                <div class="mt-4 flex gap-3 w-full">
                    <button id="detailCompleteBtn" onclick="" class="flex-1 py-2.5 bg-dark-800 text-emerald-400 font-medium rounded-xl border border-dark-700 active:scale-95 text-xs flex items-center justify-center gap-1">
                        <i data-lucide="check" class="w-3 h-3"></i> Bitirdim
                    </button>
                    <button onclick="deleteCurrentItem()" class="flex-1 py-2.5 bg-dark-800 text-red-400 font-medium rounded-xl border border-dark-700 active:scale-95 text-xs flex items-center justify-center gap-1">
                        <i data-lucide="trash" class="w-3 h-3"></i> Sil
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- === ADD ITEM SHEET === -->
    <div id="modalBackdrop" class="fixed inset-0 bg-black/80 z-40 hidden transition-opacity" onclick="closeModal()"></div>
    <div id="modalSheet" class="fixed bottom-0 left-0 right-0 bg-dark-900 rounded-t-3xl z-50 sheet-closed sheet-transition max-h-[90vh] flex flex-col border-t border-dark-700 shadow-2xl">
        <div class="w-12 h-1.5 bg-dark-700 rounded-full mx-auto mt-3 mb-1"></div>
        <div class="p-6 overflow-y-auto pb-8">
            <h3 id="modalTitle" class="text-lg font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-indigo-500"></i> Yeni İçerik Ekle</h3>
            <form id="itemForm" class="space-y-4">
                <input type="hidden" id="editItemId">
                
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Başlık</label>
                    <input type="text" id="inputTitle" required class="w-full mt-1.5 px-4 py-3.5 bg-dark-800 border border-dark-700 rounded-xl text-white focus:border-indigo-500 outline-none transition-all placeholder-gray-600">
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Link (URL)</label>
                    <div class="relative">
                        <i data-lucide="link" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                        <input type="url" id="inputUrl" required class="w-full mt-1.5 pl-10 pr-4 py-3.5 bg-dark-800 border border-dark-700 rounded-xl text-white focus:border-indigo-500 outline-none transition-all placeholder-gray-600">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1">Kategori</label>
                        <div class="relative">
                            <select id="inputMainCategory" onchange="populateSubSelect(this.value)" class="w-full mt-1.5 px-3 py-3.5 bg-dark-800 border border-dark-700 rounded-xl text-white outline-none appearance-none"></select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none mt-0.5"></i>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1">Alt Konu</label>
                        <div class="relative">
                            <select id="inputSubCategory" class="w-full mt-1.5 px-3 py-3.5 bg-dark-800 border border-dark-700 rounded-xl text-white outline-none appearance-none"></select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none mt-0.5"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Not</label>
                    <textarea id="inputNote" rows="2" class="w-full mt-1.5 px-4 py-3.5 bg-dark-800 border border-dark-700 rounded-xl text-white focus:border-indigo-500 outline-none resize-none placeholder-gray-600"></textarea>
                </div>

                <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl active:scale-95 transition-transform shadow-lg shadow-indigo-600/20 mt-4">
                    Kaydet
                </button>
            </form>
        </div>
    </div>

    <!-- === SETTINGS SHEET === -->
    <div id="settingsBackdrop" class="fixed inset-0 bg-black/80 z-40 hidden transition-opacity" onclick="toggleSettings()"></div>
    <div id="settingsSheet" class="fixed bottom-0 left-0 right-0 bg-dark-900 rounded-t-3xl z-50 sheet-closed sheet-transition max-h-[85vh] flex flex-col border-t border-dark-700">
        <div class="w-12 h-1.5 bg-dark-700 rounded-full mx-auto mt-3"></div>
        <div class="p-6 flex-1 overflow-y-auto">
            <h3 class="text-lg font-bold text-white mb-4">Ayarlar & Kategoriler</h3>
            <div class="space-y-3 mb-6">
                <button onclick="openCatModal('main')" class="w-full py-3.5 bg-dark-800 border border-dark-700 text-white rounded-xl font-medium flex items-center justify-center gap-2 active:bg-dark-700">
                    <i data-lucide="folder-plus" class="w-4 h-4 text-indigo-400"></i> Ana Kategori Ekle
                </button>
                <button onclick="openCatModal('sub')" class="w-full py-3.5 bg-dark-800 border border-dark-700 text-white rounded-xl font-medium flex items-center justify-center gap-2 active:bg-dark-700">
                    <i data-lucide="plus" class="w-4 h-4 text-gray-400"></i> Alt Kategori Ekle
                </button>
            </div>
            <div class="h-px bg-dark-800 my-6"></div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="downloadBackup()" class="py-4 bg-dark-800 rounded-xl text-xs font-bold text-emerald-400 flex flex-col items-center gap-2 active:scale-95 border border-dark-700">
                    <i data-lucide="download" class="w-5 h-5"></i> Yedeği İndir
                </button>
                <button onclick="document.getElementById('importFile').click()" class="py-4 bg-dark-800 rounded-xl text-xs font-bold text-blue-400 flex flex-col items-center gap-2 active:scale-95 border border-dark-700">
                    <i data-lucide="upload" class="w-5 h-5"></i> Yükle
                </button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="restoreBackup(this)">
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // DATA
        const defaultCategories = [
            { id: 'all', name: 'Tümü', icon: 'layers', subs: [] },
            { id: 'tarih', name: 'Tarih', icon: 'scroll', subs: [{ id: 'osmanli', name: 'Osmanlı' }] },
            { id: 'matematik', name: 'Matematik', icon: 'calculator', subs: [{ id: 'mat1', name: 'Matematik 1' }] }
        ];
        let categories = JSON.parse(localStorage.getItem('ck_cats_mobile')) || defaultCategories;
        let items = JSON.parse(localStorage.getItem('ck_items_mobile')) || [];
        let activeMainId = 'all';
        let currentDetailId = null; // Track current open detail item

        function init() {
            lucide.createIcons();
            renderCategoryTabs();
            renderItems();
        }

        function saveData() {
            localStorage.setItem('ck_cats_mobile', JSON.stringify(categories));
            localStorage.setItem('ck_items_mobile', JSON.stringify(items));
            renderCategoryTabs();
            renderItems();
        }

        // TABS
        function renderCategoryTabs() {
            const listEl = document.getElementById('categoryList');
            listEl.innerHTML = '';
            categories.forEach(cat => {
                const isActive = activeMainId === cat.id;
                const btn = document.createElement('button');
                btn.className = `flex-none px-5 py-2.5 rounded-full text-xs font-bold border transition-all ${
                    isActive 
                    ? 'cat-active shadow-lg shadow-indigo-500/30' 
                    : 'bg-dark-900 border-dark-700 text-gray-400'
                }`;
                btn.textContent = cat.name;
                btn.onclick = () => { activeMainId = cat.id; renderCategoryTabs(); renderItems(); };
                listEl.appendChild(btn);
            });
        }

        // LIST
        function renderItems() {
            const container = document.getElementById('contentArea');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';

            const filtered = items.filter(item => {
                const matchesMain = activeMainId === 'all' || item.mainId === activeMainId;
                const matchesSearch = item.title.toLowerCase().includes(searchVal) || (item.note && item.note.toLowerCase().includes(searchVal));
                return matchesMain && matchesSearch;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-700"><i data-lucide="ghost" class="w-12 h-12 mb-3 opacity-30"></i><p class="text-sm font-medium">İçerik yok</p></div>`;
                lucide.createIcons(); return;
            }

            filtered.forEach(item => {
                const isDone = item.status === 'completed';
                const mainCat = categories.find(c => c.id === item.mainId);
                const subCatName = mainCat?.subs.find(s => s.id === item.subId)?.name || '';

                const card = document.createElement('div');
                card.onclick = (e) => {
                    // Prevent opening detail if clicking buttons
                    if(e.target.closest('button')) return;
                    openDetailView(item);
                };
                card.className = `relative bg-dark-800 rounded-2xl p-5 border border-dark-700 active:scale-[0.98] transition-all shadow-sm ${isDone ? 'opacity-50 grayscale' : 'hover:border-indigo-500/50'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wide bg-dark-900 px-2 py-1 rounded border border-dark-700">
                            ${mainCat?.name} ${subCatName ? '/ ' + subCatName : ''}
                        </span>
                        <div class="flex gap-2">
                            <button onclick="editItem(${item.id})" class="text-gray-500 p-1 bg-dark-900 rounded-md border border-dark-700"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <h3 class="text-white font-bold text-base mb-1 leading-snug ${isDone ? 'line-through' : ''}">${item.title}</h3>
                    <p class="text-xs text-gray-500 line-clamp-1 mb-0">${item.note || 'Not yok'}</p>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- DETAIL VIEW ---
        function openDetailView(item) {
            currentDetailId = item.id;
            const view = document.getElementById('detailView');
            const mainCat = categories.find(c => c.id === item.mainId);
            const subCatName = mainCat?.subs.find(s => s.id === item.subId)?.name || '';

            document.getElementById('detailTitle').textContent = item.title;
            document.getElementById('detailCategory').textContent = `${mainCat?.name} ${subCatName ? ' • ' + subCatName : ''}`;
            document.getElementById('detailNote').textContent = item.note || 'Bu içerik için not eklenmemiş.';
            document.getElementById('detailLinkBtn').href = item.url;
            
            // Toggle btn state
            const toggleBtn = document.getElementById('detailCompleteBtn');
            const isDone = item.status === 'completed';
            toggleBtn.className = `flex-1 py-2.5 font-medium rounded-xl border active:scale-95 text-xs flex items-center justify-center gap-1 ${isDone ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-dark-800 text-emerald-400 border-dark-700'}`;
            toggleBtn.innerHTML = isDone ? '<i data-lucide="rotate-ccw" class="w-3 h-3"></i> Geri Al' : '<i data-lucide="check" class="w-3 h-3"></i> Bitirdim';
            toggleBtn.onclick = () => { toggleStatus(item.id); closeDetail(); };

            view.classList.remove('viewer-closed');
            view.classList.add('viewer-open');
        }

        function closeDetail() {
            const view = document.getElementById('detailView');
            view.classList.remove('viewer-open');
            view.classList.add('viewer-closed');
        }

        function deleteCurrentItem() {
            if(currentDetailId) deleteItem(currentDetailId);
            closeDetail();
        }

        // --- MODAL LOGIC ---
        function openModal(editId = null) {
            const backdrop = document.getElementById('modalBackdrop');
            const sheet = document.getElementById('modalSheet');
            const form = document.getElementById('itemForm');
            const mainSelect = document.getElementById('inputMainCategory');

            mainSelect.innerHTML = categories.filter(c => c.id !== 'all').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            if(editId) {
                const item = items.find(i => i.id === editId);
                document.getElementById('editItemId').value = item.id;
                document.getElementById('inputTitle').value = item.title;
                document.getElementById('inputUrl').value = item.url;
                document.getElementById('inputNote').value = item.note || '';
                mainSelect.value = item.mainId;
                populateSubSelect(item.mainId);
                document.getElementById('inputSubCategory').value = item.subId;
                document.getElementById('modalTitle').innerHTML = '<i data-lucide="pencil" class="w-5 h-5 text-indigo-500"></i> Düzenle';
            } else {
                form.reset();
                document.getElementById('editItemId').value = '';
                populateSubSelect(categories[1]?.id || categories[0].id); // Skip 'all'
                document.getElementById('modalTitle').innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5 text-indigo-500"></i> Yeni İçerik Ekle';
            }
            backdrop.classList.remove('hidden');
            setTimeout(() => { sheet.classList.remove('sheet-closed'); sheet.classList.add('sheet-open'); }, 10);
            lucide.createIcons();
        }

        function closeModal() {
            const backdrop = document.getElementById('modalBackdrop');
            const sheet = document.getElementById('modalSheet');
            sheet.classList.remove('sheet-open'); sheet.classList.add('sheet-closed');
            setTimeout(() => { backdrop.classList.add('hidden'); }, 300);
        }

        function toggleSettings() {
            const backdrop = document.getElementById('settingsBackdrop');
            const sheet = document.getElementById('settingsSheet');
            if (backdrop.classList.contains('hidden')) {
                backdrop.classList.remove('hidden'); setTimeout(() => { sheet.classList.remove('sheet-closed'); sheet.classList.add('sheet-open'); }, 10);
            } else {
                sheet.classList.remove('sheet-open'); sheet.classList.add('sheet-closed'); setTimeout(() => { backdrop.classList.add('hidden'); }, 300);
            }
        }

        function populateSubSelect(mainId) {
            const subSelect = document.getElementById('inputSubCategory');
            subSelect.innerHTML = '';
            const mainCat = categories.find(c => c.id === mainId);
            if(mainCat && mainCat.subs) {
                mainCat.subs.forEach(s => {
                    const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name; subSelect.appendChild(opt);
                });
            }
        }

        // --- OPERATIONS ---
        document.getElementById('itemForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editItemId').value;
            const data = {
                title: document.getElementById('inputTitle').value,
                url: document.getElementById('inputUrl').value,
                mainId: document.getElementById('inputMainCategory').value,
                subId: document.getElementById('inputSubCategory').value,
                note: document.getElementById('inputNote').value
            };
            if(id) {
                const idx = items.findIndex(i => i.id == id);
                items[idx] = { ...items[idx], ...data };
            } else {
                items.unshift({ id: Date.now(), ...data, status: 'pending', date: new Date().toLocaleDateString('tr-TR') });
            }
            saveData(); closeModal();
        });

        function toggleStatus(id) {
            const item = items.find(i => i.id === id);
            item.status = item.status === 'pending' ? 'completed' : 'pending';
            saveData();
        }

        function deleteItem(id) {
            if(confirm("Silmek istediğinize emin misiniz?")) {
                items = items.filter(i => i.id !== id);
                saveData();
            }
        }
        
        window.editItem = (id) => openModal(id);

        function openCatModal(type) {
            const name = prompt("Kategori Adı:");
            if(!name) return;
            if(type === 'main') {
                const id = name.toLowerCase().substring(0,5) + Math.floor(Math.random()*100);
                categories.push({ id, name, subs: [] });
            } else {
                if(activeMainId === 'all') return alert("Önce bir ana kategori seçin!");
                const cat = categories.find(c => c.id === activeMainId);
                const subId = name.toLowerCase().substring(0,5) + Math.floor(Math.random()*100);
                cat.subs.push({ id: subId, name });
            }
            saveData(); toggleSettings();
        }

        function downloadBackup() {
            const data = { c: categories, i: items };
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); a.download = "mobil_kutuphane.json"; document.body.appendChild(a); a.click(); a.remove();
        }

        function restoreBackup(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const d = JSON.parse(e.target.result);
                if(d.c && d.i) { if(confirm("Yüklensin mi?")) { categories = d.c; items = d.i; saveData(); location.reload(); } }
            };
            r.readAsText(f);
        }

        document.getElementById('searchInput').addEventListener('input', renderItems);
        init();
    </script>
</body>
</html>

