<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Sınavı Yönet - EduManage</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#10b981", // Emerald 500
                        "primary-hover": "#059669", // Emerald 600
                        "background-dark": "#050505", // True Black / Deep Obsidian
                        "surface-dark": "#0f0f0f", // Almost Black
                        "card-dark": "#171717", // Neutral 900
                        "border-dark": "#262626", // Neutral 800
                        "text-main": "#f5f5f5", // Neutral 100
                        "text-muted": "#737373", // Neutral 500
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"], "body": ["Manrope", "sans-serif"], "mono": ["JetBrains Mono", "monospace"] },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)',
                        'pulse-subtle': 'pulseSubtle 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(15px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        pulseSubtle: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        }
                    }
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #050505; color: #f5f5f5; font-size: 16px; overflow: hidden; }
        h1, h2, h3, h4, h5, h6, .font-display { font-family: 'Manrope', sans-serif; letter-spacing: -0.02em; }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        
        /* Modern Tech Panel */
        .glass-panel {
            background: #0f0f0f;
            border: 1px solid #262626;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* Tech Card Style */
        .glass-card {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        /* Yeni Modern Hover Efekti: Hareket yok, sadece sınır ve parlama */
        .glass-card:hover {
            border-color: #10b981; /* Primary color */
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
            background: #1a1a1a;
        }

        /* Input Styles - Flat & Minimal */
        .input-immersive {
            background: #171717;
            border: 1px solid #262626;
            color: #f5f5f5;
            transition: all 0.2s ease;
            font-family: 'Manrope', sans-serif;
        }
        .input-immersive:focus {
            border-color: #10b981;
            background: #0a0a0a;
            outline: none;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #262626; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #404040; }
        .thin-scroll::-webkit-scrollbar { width: 4px; }
        
        /* Option Card Styles */
        .option-card { 
            transition: all 0.15s ease; 
            background: #171717;
            border: 1px solid #262626;
            outline: none;
        }
        .option-card:hover:not(:disabled) { 
            background: #222; 
            border-color: #525252;
            transform: translateX(4px);
        }
        .option-card.selected-correct { border-color: #10b981; background: rgba(16, 185, 129, 0.08); color: #34d399; }
        .option-card.selected-wrong { border-color: #ef4444; background: rgba(239, 68, 68, 0.08); color: #f87171; }
        .option-card.disabled { opacity: 0.5; cursor: default; transform: none !important; }
        
        button { outline: none !important; } 
    </style>
</head>
<body class="bg-background-dark text-text-main transition-colors duration-200 min-h-screen flex overflow-hidden selection:bg-primary selection:text-black">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-background-dark flex items-center justify-center p-4 overflow-hidden">
        <!-- Abstract Decoration -->
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary via-emerald-900 to-black"></div>
        <div class="absolute bottom-0 right-0 w-96 h-96 bg-primary/5 rounded-full blur-[100px] pointer-events-none"></div>
        
        <div class="w-full max-w-sm bg-surface-dark p-8 rounded-2xl border border-border-dark text-center animate-fade-in relative z-10 shadow-2xl shadow-black">
            <div class="w-16 h-16 mx-auto mb-6 bg-card-dark rounded-xl flex items-center justify-center border border-border-dark text-primary shadow-[0_0_20px_rgba(16,185,129,0.1)]">
                <span class="material-symbols-rounded text-4xl">school</span>
            </div>
            
            <h1 class="text-2xl font-bold text-white mb-2 tracking-tight">EduManage</h1>
            <p class="text-text-muted text-xs mb-8 uppercase tracking-widest font-semibold">Öğrenme Platformu</p>
            
            <div id="config-error" class="hidden mb-4 bg-red-500/5 border border-red-500/20 p-3 rounded-lg text-left">
                <p class="text-red-400 text-xs font-bold flex items-center gap-2"><span class="material-symbols-rounded text-sm">error</span> Yapılandırma Hatası</p>
            </div>

            <form onsubmit="handleAuth(event)" class="space-y-3 text-left">
                <div class="group">
                    <label class="text-[10px] font-bold text-text-muted ml-1 mb-1 block uppercase tracking-wider">E-Posta</label>
                    <input type="email" name="email" required placeholder="ornek@email.com" class="w-full input-immersive rounded-lg p-3 text-sm placeholder:text-neutral-700">
                </div>
                <div class="group">
                    <label class="text-[10px] font-bold text-text-muted ml-1 mb-1 block uppercase tracking-wider">Şifre</label>
                    <input type="password" name="password" required placeholder="••••••••" class="w-full input-immersive rounded-lg p-3 text-sm placeholder:text-neutral-700">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-primary hover:bg-primary-hover text-black py-3 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2 mt-4 shadow-lg shadow-primary/20 hover:scale-[1.01] active:scale-[0.99]">
                    <span>Giriş Yap</span>
                </button>
            </form>

            <div class="mt-6 pt-6 border-t border-border-dark">
                <button onclick="toggleAuthMode()" class="text-text-muted hover:text-white text-xs font-medium transition-colors w-full text-center flex items-center justify-center gap-1 group" id="auth-toggle-btn">
                    Hesabın yok mu? <span class="text-primary group-hover:underline font-bold">Kayıt Ol</span>
                </button>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-wrapper" class="flex w-full h-full hidden animate-fade-in bg-background-dark relative">
        
        <!-- Sidebar -->
        <aside class="w-72 bg-surface-dark border-r border-border-dark flex-col hidden lg:flex shrink-0 h-screen z-20 relative">
            <div class="h-16 flex items-center px-5 relative z-10 border-b border-border-dark bg-surface-dark">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                        <span class="material-symbols-rounded text-xl">school</span>
                    </div>
                    <span class="text-base font-bold text-white tracking-tight">EduManage</span>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto py-6 px-4 flex flex-col gap-1 relative z-10">
                <div class="mb-6 p-4 bg-card-dark rounded-xl border border-border-dark flex items-center gap-4 shadow-lg">
                    <div class="w-10 h-10 rounded-lg bg-neutral-800 flex items-center justify-center text-white font-bold text-sm shrink-0 border border-neutral-700 shadow-inner">
                        <span id="user-avatar-initial">K</span>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-[10px] font-bold text-text-muted uppercase tracking-wider">Kullanıcı</p>
                        <p class="text-sm font-bold text-white leading-tight truncate" id="user-email-display">...</p>
                    </div>
                </div>

                <p class="px-2 text-[10px] font-bold text-text-muted uppercase tracking-widest mb-1 mt-2">Menü</p>
                
                <button onclick="router('dashboard')" id="nav-dashboard" class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-muted hover:bg-card-dark hover:text-white transition-all w-full text-left group">
                    <span class="material-symbols-rounded text-[20px]">dashboard</span>
                    <span class="text-sm font-semibold">Genel Bakış</span>
                </button>
                <button onclick="router('content')" id="nav-content" class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-muted hover:bg-card-dark hover:text-white transition-all w-full text-left group">
                    <span class="material-symbols-rounded text-[20px]">library_books</span>
                    <span class="text-sm font-semibold">Test Kütüphanesi</span>
                </button>
                
                <div class="mt-auto pt-3 border-t border-border-dark">
                    <button onclick="handleLogout()" class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-muted hover:bg-red-500/10 hover:text-red-400 transition-all w-full text-left group">
                        <span class="material-symbols-rounded text-[20px]">logout</span>
                        <span class="text-sm font-semibold">Çıkış Yap</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative z-10 bg-background-dark">
            <!-- Mobile Header -->
            <div class="lg:hidden h-16 bg-surface-dark border-b border-border-dark flex items-center justify-between px-5 shrink-0 z-30">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-rounded text-primary text-xl">school</span>
                    <span class="font-bold text-white text-lg">EduManage</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="router('dashboard')" class="p-2 text-text-muted hover:text-white"><span class="material-symbols-rounded">dashboard</span></button>
                    <button onclick="router('content')" class="p-2 text-text-muted hover:text-white"><span class="material-symbols-rounded">library_books</span></button>
                    <button onclick="handleLogout()" class="p-2 text-text-muted hover:text-white"><span class="material-symbols-rounded">logout</span></button>
                </div>
            </div>

            <!-- Dynamic Content Area -->
            <div id="app-container" class="flex-1 overflow-hidden relative w-full h-full">
                <!-- Loader -->
                <div class="flex justify-center items-center h-full">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-surface-dark rounded-2xl w-full max-w-xl shadow-2xl transform scale-95 opacity-0 transition-all duration-200 flex flex-col max-h-[90vh] border border-border-dark" id="modal-content">
            <div class="p-5 border-b border-border-dark flex justify-between items-center shrink-0">
                <h3 id="modal-title" class="text-base font-bold text-white">Başlık</h3>
                <button onclick="closeModal()" class="text-text-muted hover:text-white transition-colors p-1.5 rounded-lg hover:bg-card-dark">
                    <span class="material-symbols-rounded text-xl">close</span>
                </button>
            </div>
            <div id="modal-body" class="p-5 overflow-y-auto thin-scroll">
                <!-- Dynamic Form -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-8 right-8 bg-surface-dark border border-border-dark text-white px-5 py-3 rounded-lg shadow-2xl transform translate-y-32 opacity-0 transition-all duration-300 z-[80] flex items-center gap-3 text-xs font-bold shadow-black/50">
        <span class="material-symbols-rounded filled text-lg text-primary">check_circle</span>
        <span id="toast-message">Başarılı</span>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const myFirebaseConfig = {
             apiKey: "AIzaSyBRyvBSrNc5QKFWiMryYbHG-s4DXf4IIrc",
             authDomain: "kpss-takip-75477.firebaseapp.com",
             projectId: "kpss-takip-75477",
             storageBucket: "kpss-takip-75477.firebasestorage.app",
             messagingSenderId: "1083935832054",
             appId: "1:1083935832054:web:d02f57e3721e39f286b9d7",
             measurementId: "G-QFLEBQEHBC"
        };
        const firebaseConfig = (envConfig.apiKey) ? envConfig : myFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app, auth, db;
        try {
            if (!firebaseConfig.apiKey) {
                document.getElementById('config-error').classList.remove('hidden');
                document.getElementById('auth-submit-btn').disabled = true;
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch(e) {
            console.error(e);
            document.getElementById('config-error').classList.remove('hidden');
        }

        // --- State ---
        let currentUser = null;
        let categories = [], subcategories = [], tests = [], questions = [], results = [];
        let loading = true;
        let dbError = null;
        let currentView = 'dashboard'; 
        let contentFilter = { catId: 'all', subId: 'all', search: '' };
        let activeQuizData = null; 
        let isLoginMode = true;
        let currentEditingId = null;

        // --- Auth Functions ---
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            const btn = document.getElementById('auth-submit-btn');
            const toggle = document.getElementById('auth-toggle-btn');
            if (isLoginMode) {
                btn.querySelector('span').innerText = "Giriş Yap";
                toggle.innerHTML = `Hesabın yok mu? <span class="text-white group-hover:underline font-bold">Kayıt Ol</span>`;
            } else {
                btn.querySelector('span').innerText = "Kayıt Ol";
                toggle.innerHTML = `Zaten üye misin? <span class="text-white group-hover:underline font-bold">Giriş Yap</span>`;
            }
        };

        window.handleAuth = async (e) => {
            e.preventDefault();
            if (!auth) { showToast("Firebase Hatası: Bağlantı yok.", "error"); return; }
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const btn = document.getElementById('auth-submit-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-black"></div>`;

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (err) {
                console.error(err);
                let msg = "İşlem başarısız.";
                if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') msg = "Hatalı e-posta veya şifre.";
                else if (err.code === 'auth/email-already-in-use') msg = "Bu e-posta zaten kullanımda.";
                else if (err.code === 'auth/weak-password') msg = "Şifre çok zayıf (en az 6 karakter).";
                else if (err.code === 'auth/network-request-failed') msg = "Bağlantı hatası.";
                
                showToast(msg, "error");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        window.handleLogout = async () => { if(auth) { await signOut(auth); location.reload(); } };

        // --- Core Functions ---
        async function init() {
            if (!auth) return;
            
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { console.error("Token login failed", e); }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    const displayEmail = user.email;
                    document.getElementById('user-avatar-initial').innerText = displayEmail.charAt(0).toUpperCase();
                    document.getElementById('user-email-display').innerText = displayEmail;
                    
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-wrapper').classList.remove('hidden');
                    startListeners();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-wrapper').classList.add('hidden');
                }
            });
        }

        function startListeners() {
            if(!currentUser) return;
            const userPath = `artifacts/${appId}/users/${currentUser.uid}`;
            const handleSnap = (setter, snap) => { setter(snap.docs.map(d => ({ id: d.id, ...d.data() }))); checkLoading(); };
            const handleError = (err) => { console.error("Firestore Error:", err); dbError = err.message; loading = false; refreshUI(); };

            onSnapshot(collection(db, userPath, 'categories'), (s) => handleSnap(d => categories = d, s), handleError);
            onSnapshot(collection(db, userPath, 'subcategories'), (s) => handleSnap(d => subcategories = d, s), handleError);
            onSnapshot(collection(db, userPath, 'tests'), (s) => handleSnap(d => tests = d, s), handleError);
            onSnapshot(collection(db, userPath, 'questions'), (s) => handleSnap(d => questions = d, s), handleError);
            onSnapshot(collection(db, userPath, 'results'), (s) => handleSnap(d => results = d, s), handleError);
        }

        function checkLoading() { if(loading) { loading = false; refreshUI(); } else { refreshUI(); } }

        window.router = function(view) {
            currentView = view;
            if (document.activeElement instanceof HTMLElement) { document.activeElement.blur(); }
            if (view !== 'content') { contentFilter = { catId: 'all', subId: 'all', search: '' }; }
            updateNavStyles(view);
            render();
        }

        window.toggleCategory = (id) => {
            if (contentFilter.catId === id) { contentFilter.catId = 'all'; } else { contentFilter.catId = id; }
            contentFilter.subId = 'all';
            
            // OPTIMIZATION: Only update Sidebar and Grid, do NOT re-render the whole page (search bar etc)
            document.getElementById('content-sidebar').innerHTML = getSidebarHTML();
            document.getElementById('test-grid').innerHTML = getGridHTML();
            // Re-apply search filter logic immediately
            handleSearch(contentFilter.search);
        };

        window.filterBySubCategory = (id) => { 
            contentFilter.subId = id; 
            
            // OPTIMIZATION: Only update Sidebar and Grid
            document.getElementById('content-sidebar').innerHTML = getSidebarHTML();
            document.getElementById('test-grid').innerHTML = getGridHTML();
            // Re-apply search filter logic immediately
            handleSearch(contentFilter.search);
        };

        function updateNavStyles(view) {
            document.querySelectorAll('aside button').forEach(btn => {
                btn.classList.remove('bg-card-dark', 'text-white', 'shadow-sm', 'border', 'border-border-dark');
                btn.classList.add('text-text-muted');
            });
            const activeBtn = document.getElementById(`nav-${view}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-text-muted');
                activeBtn.classList.add('bg-card-dark', 'text-white', 'shadow-sm', 'border', 'border-border-dark'); 
            }
        }

        function refreshUI() { render(); }

        // --- Live Search Handler ---
        window.handleSearch = (value) => {
            contentFilter.search = value; // Store in state
            const searchTerm = value.toLocaleLowerCase('tr-TR');
            const cards = document.querySelectorAll('.test-card-item');
            let hasResults = false;

            cards.forEach(card => {
                const title = card.getAttribute('data-title') || '';
                // Only show if it matches search AND matches current category filters (which are already applied by render)
                // Actually, render already filtered by category, so we just toggle hidden based on search
                if (title.includes(searchTerm)) {
                    card.classList.remove('hidden');
                    hasResults = true;
                } else {
                    card.classList.add('hidden');
                }
            });

            const noResultEl = document.getElementById('no-search-results');
            if (noResultEl) {
                if (!hasResults && cards.length > 0) {
                    noResultEl.classList.remove('hidden');
                } else {
                    noResultEl.classList.add('hidden');
                }
            }
        };

        function render() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';

            if (dbError) {
                container.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full animate-fade-in p-8 text-center">
                        <div class="w-16 h-16 bg-card-dark rounded-full flex items-center justify-center text-red-400 mb-4 border border-border-dark"><span class="material-symbols-rounded text-3xl">error</span></div>
                        <h2 class="text-xl font-bold text-white mb-2">Veri Erişim Hatası</h2>
                        <p class="text-text-muted text-sm max-w-md">${dbError}</p>
                    </div>`;
                return;
            }

            if (loading) {
                container.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full animate-fade-in">
                        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-4"></div>
                        <p class="text-text-muted text-base">Yükleniyor...</p>
                    </div>`;
                return;
            }

            // Normal container for non-quiz views
            const isQuiz = currentView === 'quiz_active';
            const baseClass = isQuiz ? "w-full h-full" : "w-full h-full p-6 md:p-8 overflow-y-auto no-scrollbar";
            
            const wrapper = document.createElement('div');
            wrapper.className = baseClass;
            container.appendChild(wrapper);

            if (currentView === 'dashboard') renderDashboard(wrapper);
            else if (currentView === 'content') renderContentSplit(wrapper);
            else if (currentView === 'quiz_active') renderActiveQuiz(container); // Pass container directly
            else if (currentView === 'quiz_review') renderQuizReview(wrapper);
        }

        // --- DASHBOARD ---
        function renderDashboard(container) {
            const totalTestsSolved = results.length;
            const totalCorrect = results.reduce((acc, curr) => acc + (curr.score || 0), 0);
            const totalPossible = results.reduce((acc, curr) => acc + (curr.totalQuestions || 0), 0);
            const overallSuccess = totalPossible > 0 ? Math.round((totalCorrect / totalPossible) * 100) : 0;
            const totalErrors = totalPossible - totalCorrect;

            const catStats = {};
            categories.forEach(c => catStats[c.id] = { name: c.name, correct: 0, total: 0 });
            results.forEach(r => {
                const test = tests.find(t => t.id === r.testId);
                if(test) {
                    const sub = subcategories.find(s => s.id === test.subId);
                    if(sub && catStats[sub.catId]) { catStats[sub.catId].correct += r.score; catStats[sub.catId].total += r.totalQuestions; }
                }
            });

            const recentResults = [...results].sort((a,b) => b.timestamp - a.timestamp).slice(0, 5);

            if (categories.length === 0 && tests.length === 0) {
                 container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-center animate-fade-in">
                        <div class="bg-surface-dark p-12 rounded-3xl max-w-lg border border-border-dark shadow-2xl">
                            <div class="w-16 h-16 bg-card-dark rounded-2xl flex items-center justify-center text-primary text-4xl mb-6 mx-auto border border-border-dark"><span class="material-symbols-rounded">school</span></div>
                            <h2 class="text-2xl font-bold text-white mb-2">Hoş Geldiniz!</h2>
                            <p class="text-text-muted text-sm mb-8 leading-relaxed">Henüz test kütüphaneniz boş görünüyor. İlk testinizi oluşturarak öğrenme yolculuğuna başlayın.</p>
                            <button onclick="openModal('global-test-json')" class="w-full bg-white hover:bg-neutral-200 text-black py-4 rounded-xl font-bold text-sm transition-transform hover:scale-105">İlk Testi Oluştur</button>
                        </div>
                    </div>`;
                return;
            }
            
            const statsHtml = Object.values(catStats).filter(c => c.total > 0).map(c => {
                const pct = Math.round((c.correct / c.total) * 100);
                let colorClass = pct >= 70 ? 'bg-emerald-500' : (pct >= 50 ? 'bg-amber-500' : 'bg-red-500');
                return `
                <div class="mb-5">
                    <div class="flex justify-between text-xs font-bold mb-2">
                        <span class="text-text-muted tracking-wide uppercase">${c.name}</span>
                        <span class="${pct >= 70 ? 'text-emerald-500' : (pct >= 50 ? 'text-amber-500' : 'text-red-500')}">%${pct}</span>
                    </div>
                    <div class="w-full bg-card-dark rounded-full h-2 overflow-hidden border border-border-dark">
                        <div class="${colorClass} h-full rounded-full transition-all duration-1000" style="width: ${pct}%"></div>
                    </div>
                </div>`;
            }).join('') || '<p class="text-text-muted text-sm italic text-center py-6">Henüz veri yok.</p>';

            const historyHtml = recentResults.map(r => {
                const t = tests.find(x => x.id === r.testId);
                const date = new Date(r.timestamp).toLocaleDateString('tr-TR', {day:'numeric', month:'short'});
                const pct = Math.round((r.score/r.totalQuestions)*100);
                const gradeColor = pct >= 70 ? 'text-emerald-500 bg-emerald-500/10 border-emerald-500/20' : 'text-text-muted bg-card-dark';
                return `
                <div class="flex items-center justify-between p-4 hover:bg-card-dark rounded-xl transition-all mb-2 group cursor-default border border-transparent hover:border-border-dark">
                    <div class="flex items-center gap-4 min-w-0">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xs font-bold ${gradeColor} shrink-0 border">
                            <span>%${pct}</span>
                        </div>
                        <div class="overflow-hidden min-w-0 flex-1">
                            <p class="text-white text-sm font-bold leading-tight line-clamp-1">${t ? t.title : 'Silinmiş Test'}</p>
                            <p class="text-xs text-text-muted mt-0.5 font-medium uppercase tracking-wide">${date}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 shrink-0">
                        <span class="text-xs font-mono text-text-muted font-bold">${r.score}/${r.totalQuestions}</span>
                        ${t ? `<button onclick="startQuiz('${t.id}')" class="bg-white/5 hover:bg-white text-white hover:text-black p-2 rounded-lg transition-colors" title="Tekrar Çöz">
                            <span class="material-symbols-rounded text-lg block">refresh</span>
                        </button>` : ''}
                    </div>
                </div>`;
            }).join('') || '<p class="text-text-muted text-sm p-6 text-center">Henüz aktivite yok.</p>';

            container.innerHTML = `
                <div class="animate-fade-in">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold tracking-tight text-white font-display">Genel Bakış</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="glass-card p-6 h-40 flex flex-col justify-between">
                            <div class="flex items-start justify-between">
                                <span class="text-text-muted font-bold text-xs uppercase tracking-wider">Genel Başarı</span>
                                <span class="material-symbols-rounded text-neutral-700 text-2xl">check_circle</span>
                            </div>
                            <p class="text-4xl font-bold text-white tracking-tight">%${overallSuccess}</p>
                        </div>
                        <div class="glass-card p-6 h-40 flex flex-col justify-between">
                            <div class="flex items-start justify-between">
                                <span class="text-text-muted font-bold text-xs uppercase tracking-wider">Tamamlanan</span>
                                <span class="material-symbols-rounded text-neutral-700 text-2xl">quiz</span>
                            </div>
                            <p class="text-4xl font-bold text-white tracking-tight">${totalTestsSolved}</p>
                        </div>
                         <div class="glass-card p-6 h-40 flex flex-col justify-between">
                             <div class="flex items-start justify-between">
                                <span class="text-text-muted font-bold text-xs uppercase tracking-wider">Hata Sayısı</span>
                                <span class="material-symbols-rounded text-neutral-700 text-2xl">warning</span>
                            </div>
                            <p class="text-4xl font-bold text-white tracking-tight">${totalErrors}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass-panel rounded-2xl p-6">
                            <h3 class="font-bold text-white mb-6 text-sm flex items-center gap-2 uppercase tracking-wide">
                                Ders Bazlı Başarı
                            </h3>
                            <div class="space-y-2">
                                ${statsHtml}
                            </div>
                        </div>

                        <div class="glass-panel rounded-2xl overflow-hidden h-fit">
                             <div class="p-5 border-b border-border-dark bg-card-dark/50">
                                <h3 class="font-bold text-white text-sm uppercase tracking-wide">Son Aktiviteler</h3>
                             </div>
                             <div class="p-3">
                                ${historyHtml}
                             </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- HELPER FUNCTIONS FOR CONTENT VIEW ---
        function getSidebarHTML() {
            return `
                <div class="flex justify-between items-center px-2 pb-4 mb-2 border-b border-border-dark">
                    <h3 class="font-bold text-white text-sm uppercase tracking-wider">Filtrele</h3>
                    <button onclick="openModal('category')" class="text-white bg-card-dark hover:bg-neutral-700 transition-colors text-xs font-bold py-1.5 px-3 rounded-lg border border-border-dark">+ Ekle</button>
                </div>
                <div class="space-y-2">
                    <button onclick="toggleCategory('all')" class="w-full text-left px-4 py-3 rounded-xl text-sm font-bold transition-all ${contentFilter.catId === 'all' ? 'bg-card-dark text-white border border-border-dark' : 'text-text-muted hover:bg-surface-dark hover:text-white'}">
                        Tüm Testler
                    </button>
                    ${categories.map(c => `
                        <div>
                            <div class="flex items-center justify-between group rounded-xl transition-colors ${contentFilter.catId === c.id ? 'bg-surface-dark' : 'hover:bg-surface-dark'}">
                                <button onclick="toggleCategory('${c.id}')" class="flex-1 text-left px-4 py-3 text-sm font-bold ${contentFilter.catId === c.id ? 'text-white' : 'text-text-muted group-hover:text-white'}">
                                    ${c.name}
                                </button>
                                <div class="flex items-center pr-3 gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openModal('subcategory', '${c.id}')" class="text-text-muted hover:text-white p-1.5"><span class="material-symbols-rounded text-sm">add</span></button>
                                    <button onclick="deleteItem('categories', '${c.id}')" class="text-text-muted hover:text-red-400 p-1.5"><span class="material-symbols-rounded text-sm">delete</span></button>
                                </div>
                            </div>
                            ${contentFilter.catId === c.id ? `
                                <div class="pl-4 space-y-1 mt-1 ml-2 border-l border-border-dark">
                                    ${subcategories.filter(s => s.catId === c.id).map(s => `
                                        <div class="flex items-center justify-between group py-2 pr-2 pl-3 rounded-lg hover:bg-surface-dark">
                                            <button onclick="filterBySubCategory('${s.id}')" class="text-left text-xs font-semibold transition-colors ${contentFilter.subId === s.id ? 'text-white' : 'text-text-muted hover:text-white'}">
                                                ${s.name}
                                            </button>
                                                <button onclick="deleteItem('subcategories', '${s.id}')" class="opacity-0 group-hover:opacity-100 text-text-muted hover:text-red-400"><span class="material-symbols-rounded text-xs">close</span></button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>`;
        }

        function getGridHTML() {
            let filteredTests = tests;
            // 1. Filter by Category / Subcategory
            if (contentFilter.catId !== 'all') {
                const validSubIds = subcategories.filter(s => s.catId === contentFilter.catId).map(s => s.id);
                filteredTests = filteredTests.filter(t => validSubIds.includes(t.subId));
            }
            if (contentFilter.subId !== 'all') {
                filteredTests = filteredTests.filter(t => t.subId === contentFilter.subId);
            }
            // NOTE: We do NOT filter by search term here anymore to support proper live search/backspace
            // The search filter is applied via CSS class toggling in handleSearch

            if (filteredTests.length === 0) {
                return `<div class="p-20 text-center text-text-muted border border-dashed border-border-dark rounded-2xl col-span-full flex flex-col items-center justify-center bg-card-dark/20 h-96">
                    <div class="w-16 h-16 bg-card-dark rounded-full flex items-center justify-center mb-4 border border-border-dark"><span class="material-symbols-rounded text-3xl opacity-50">search_off</span></div>
                    <p class="font-medium text-sm">Bu filtreye uygun test bulunamadı.</p>
                    <button onclick="openModal('global-test-json')" class="text-white hover:underline mt-4 text-sm font-bold bg-primary px-6 py-2 rounded-lg text-black">Yeni Test Ekle</button>
                   </div>`;
            }

            return filteredTests.map((t, index) => {
                const subcat = subcategories.find(s => s.id === t.subId);
                const cat = subcat ? categories.find(c => c.id === subcat.catId) : null;
                const result = results.filter(r => r.testId === t.id).sort((a,b) => b.timestamp - a.timestamp)[0];
                
                return `
                <div class="test-card-item glass-card p-6 flex flex-col h-full relative group animate-slide-up hover:border-primary/40 hover:bg-[#222] transition-colors duration-200" 
                        style="animation-delay: ${index * 30}ms"
                        data-title="${t.title.toLowerCase()}" 
                        data-subid="${t.subId}">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-text-muted text-[10px] uppercase font-bold truncate max-w-[70%] tracking-widest bg-background-dark px-3 py-1.5 rounded-lg border border-border-dark">
                            ${cat?.name || 'Genel'}
                        </span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-background-dark rounded-lg p-1 border border-border-dark">
                            <button onclick="openModal('global-test-json', '${t.id}')" class="text-text-muted hover:text-white p-1.5"><span class="material-symbols-rounded text-base">edit</span></button>
                            <button onclick="deleteItem('tests', '${t.id}')" class="text-text-muted hover:text-red-400 p-1.5"><span class="material-symbols-rounded text-base">delete</span></button>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-white leading-snug mb-1 line-clamp-2 h-[3.2rem]" title="${t.title}">${t.title}</h3>
                    ${t.description ? `<p class="text-xs text-text-muted mb-2 line-clamp-1 opacity-80">${t.description}</p>` : ''}
                    <p class="text-xs text-text-muted mb-6 font-medium">${subcat?.name || ''}</p>
                    
                    ${result 
                        ? `<div class="text-emerald-500 text-xs font-bold mb-4 flex items-center gap-2 bg-emerald-500/5 py-1.5 px-3 rounded-lg border border-emerald-500/10 w-fit"><span class="material-symbols-rounded text-base">check_circle</span> %${Math.round(result.score/result.totalQuestions*100)} Tamamlandı</div>` 
                        : '<div class="h-8 mb-4"></div>' 
                    }
                    
                    <div class="mt-auto pt-5 border-t border-border-dark flex items-center justify-between">
                        <span class="text-xs text-text-muted font-bold flex items-center gap-1.5"><span class="material-symbols-rounded text-base">list</span> ${t.questionCount || 0} Soru</span>
                        <button onclick="startQuiz('${t.id}')" class="bg-white text-black hover:bg-gray-200 px-5 py-2.5 rounded-xl text-xs font-bold transition-all flex items-center gap-2 shadow-lg">
                            ${result ? 'Tekrar' : 'Başla'} <span class="material-symbols-rounded text-base">arrow_forward</span>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- CONTENT PAGE ---
        function renderContentSplit(container) {
            // Initial render
            const sidebarHtmlContent = getSidebarHTML();
            const cardsHtmlContent = getGridHTML();
            
            container.innerHTML = `
                <div class="flex h-full animate-fade-in gap-8 overflow-hidden w-full">
                    <div id="content-sidebar" class="w-72 shrink-0 glass-panel flex flex-col gap-3 overflow-y-auto no-scrollbar rounded-2xl m-6 mr-0 p-5 border border-border-dark h-[calc(100vh-3rem)]">
                        ${sidebarHtmlContent}
                    </div>
                    <div class="flex-1 flex flex-col h-full overflow-hidden pt-6 pb-0 pr-6">
                        <div class="flex justify-between items-center mb-8 shrink-0 gap-6">
                            <div class="relative flex-1 max-w-xl group">
                                <span class="material-symbols-rounded absolute left-4 top-3.5 text-text-muted text-xl">search</span>
                                <!-- Live Search Input -->
                                <input type="text" id="search-input" 
                                       placeholder="Test kütüphanesinde ara..." 
                                       oninput="handleSearch(this.value)" 
                                       value="${contentFilter.search}" 
                                       class="w-full input-immersive rounded-xl py-3.5 pl-14 pr-4 text-base focus:bg-card-dark placeholder:text-gray-600">
                            </div>
                            <button onclick="openModal('global-test-json')" class="bg-white hover:bg-gray-200 text-black border border-transparent px-6 py-3.5 rounded-xl text-sm font-bold flex items-center gap-2 shrink-0 transition-all shadow-lg hover:scale-105">
                                <span class="material-symbols-rounded text-xl">add</span> Yeni Test
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar pb-20 relative">
                            <!-- No Results Message (Hidden by default) -->
                            <div id="no-search-results" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <div class="w-12 h-12 bg-card-dark rounded-full flex items-center justify-center mb-3"><span class="material-symbols-rounded text-text-muted">search_off</span></div>
                                <p class="text-text-muted text-sm font-bold">Sonuç bulunamadı</p>
                            </div>
                            <!-- Genişletilmiş Grid Yapısı -->
                            <div id="test-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                                ${cardsHtmlContent}
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Apply initial search if exists
            if (contentFilter.search) {
                setTimeout(() => handleSearch(contentFilter.search), 0);
            }
        }

        // --- IMMERSIVE QUIZ UI ---
        
        window.startQuiz = (testId) => {
            const test = tests.find(t => t.id === testId);
            const qs = questions.filter(q => q.testId === testId);
            if(qs.length === 0) return showToast("Hata", "Bu testte soru bulunmuyor.", "error");
            activeQuizData = { test, questions: qs, answers: {}, currentIndex: 0 };
            router('quiz_active');
        }

        window.submitQuiz = async () => {
            if(!confirm("Testi bitirmek istiyor musun?")) return;
            let correct = 0;
            activeQuizData.questions.forEach(q => { if(activeQuizData.answers[q.id] == q.correctIndex) correct++; });
            const userPath = `artifacts/${appId}/users/${currentUser.uid}`;
            try {
                await addDoc(collection(db, userPath, 'results'), { testId: activeQuizData.test.id, score: correct, totalQuestions: activeQuizData.questions.length, timestamp: Date.now() });
                router('quiz_review');
            } catch(e) { console.error(e); }
        }

        window.selectOption = (qId, index) => {
            if (activeQuizData.answers[qId] !== undefined) return; 
            activeQuizData.answers[qId] = index;
            const q = activeQuizData.questions[activeQuizData.currentIndex];
            
            // UI Update Logic
            q.options.forEach((_, i) => {
                const btn = document.getElementById(`opt-btn-${i}`);
                if(!btn) return;
                btn.disabled = true;
                btn.classList.remove('hover:bg-background-dark');
                btn.classList.add('cursor-default');

                if (i === q.correctIndex) {
                    btn.classList.add('selected-correct');
                    btn.querySelector('.opt-letter').classList.replace('border-text-muted', 'border-emerald-500');
                    btn.querySelector('.opt-letter').classList.replace('text-text-muted', 'text-emerald-500');
                } else if (i === index) {
                    btn.classList.add('selected-wrong');
                    btn.querySelector('.opt-letter').classList.replace('border-text-muted', 'border-red-500');
                    btn.querySelector('.opt-letter').classList.replace('text-text-muted', 'text-red-500');
                } else {
                    btn.classList.add('disabled');
                }
            });

            // Button Logic
            const actionContainer = document.getElementById('quiz-header-actions');
            const prevBtn = activeQuizData.currentIndex > 0 
                ? `<button onclick="quizNav(-1)" class="bg-card-dark text-white hover:bg-gray-800 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 border border-border-dark shadow-lg"><span class="material-symbols-rounded text-lg">arrow_back</span> <span class="hidden md:inline">Önceki</span></button>` 
                : ``;

            const isLast = activeQuizData.currentIndex === activeQuizData.questions.length - 1;
            if (isLast) {
                actionContainer.innerHTML = `${prevBtn}<button onclick="submitQuiz()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2 animate-fade-in shadow-lg shadow-emerald-500/20">Bitir <span class="material-symbols-rounded text-lg">check</span></button>`;
            } else {
                actionContainer.innerHTML = `${prevBtn}<button onclick="quizNav(1)" class="bg-white text-black hover:bg-gray-200 px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2 animate-fade-in shadow-lg">Sonraki <span class="material-symbols-rounded text-lg">arrow_forward</span></button>`;
            }

            // DYNAMIC EXPLANATION
            if (q.explanation && q.explanation.trim() !== "") {
                const expWrapper = document.getElementById('quiz-explanation-wrapper');
                const expContent = document.getElementById('quiz-explanation-text');
                if(expWrapper && expContent) {
                    expContent.innerText = q.explanation;
                    expWrapper.classList.remove('hidden'); 
                    // Scroll to bottom if needed (smooth)
                    setTimeout(() => {
                          const container = document.querySelector('.quiz-content-area');
                          if(container) container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                    }, 100);
                }
            }
        }

        window.quizNav = (direction) => {
            const newIndex = activeQuizData.currentIndex + direction;
            if (newIndex >= 0 && newIndex < activeQuizData.questions.length) {
                activeQuizData.currentIndex = newIndex;
                const qText = document.getElementById('quiz-question-text');
                if (qText) {
                    const q = activeQuizData.questions[newIndex];
                    const progress = ((newIndex + 1) / activeQuizData.questions.length) * 100;
                    const ans = activeQuizData.answers[q.id];
                    const isAnswered = ans !== undefined;

                    // Reset Explanation: Always hide initially when navigating
                    const expWrapper = document.getElementById('quiz-explanation-wrapper');
                    if(expWrapper) expWrapper.classList.add('hidden');

                    // Fade Effect
                    qText.style.opacity = '0';
                    setTimeout(() => { qText.innerText = q.text; qText.style.opacity = '1'; }, 100);

                    document.getElementById('quiz-counter-current').innerText = newIndex + 1;
                    document.getElementById('quiz-progress').style.width = `${progress}%`;

                    const optionsContainer = document.getElementById('quiz-options-list');
                    optionsContainer.innerHTML = q.options.map((opt, i) => {
                        let baseClass = "w-full text-left p-4 rounded-xl option-card relative overflow-hidden flex items-center gap-4 text-text-main text-base font-medium transition-all duration-200 border border-border-dark";
                        let statusClass = "hover:bg-background-dark";
                        let letterClass = "border-text-muted text-text-muted";
                        
                        if (isAnswered) {
                            if (i == q.correctIndex) { statusClass = "selected-correct"; letterClass = "border-emerald-500 text-emerald-500"; }
                            else if (i == ans) { statusClass = "selected-wrong"; letterClass = "border-red-500 text-red-500"; }
                            else statusClass = "disabled";
                        }

                        return `
                        <button id="opt-btn-${i}" onclick="selectOption('${q.id}', ${i})" class="${baseClass} ${statusClass}" ${isAnswered ? 'disabled' : ''}>
                            <div class="opt-letter w-8 h-8 rounded-lg border-2 ${letterClass} flex items-center justify-center text-sm font-bold transition-colors shrink-0">
                                ${String.fromCharCode(65+i)}
                            </div>
                            <span class="leading-relaxed text-left">${opt}</span>
                        </button>`;
                    }).join('');

                    const actionContainer = document.getElementById('quiz-header-actions');
                    const prevBtn = newIndex > 0 
                        ? `<button onclick="quizNav(-1)" class="bg-card-dark text-white hover:bg-gray-800 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 border border-border-dark shadow-lg"><span class="material-symbols-rounded text-lg">arrow_back</span> <span class="hidden md:inline">Önceki</span></button>` 
                        : ``;

                    const isLast = newIndex === activeQuizData.questions.length - 1;
                    if (isLast) {
                        actionContainer.innerHTML = `${prevBtn}<button onclick="submitQuiz()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2 animate-fade-in shadow-lg shadow-emerald-500/20">Bitir <span class="material-symbols-rounded text-lg">check</span></button>`;
                    } else {
                        actionContainer.innerHTML = `${prevBtn}<button onclick="quizNav(1)" class="bg-white text-black hover:bg-gray-200 px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2 animate-fade-in shadow-lg">Sonraki <span class="material-symbols-rounded text-lg">arrow_forward</span></button>`;
                    }
                    
                } else { render(); }
            }
        }

        function renderActiveQuiz(container) {
            const { test, questions, currentIndex, answers } = activeQuizData;
            const q = questions[currentIndex];
            const ans = answers[q.id];
            const isAnswered = ans !== undefined;
            const progress = ((currentIndex + 1) / questions.length) * 100;

            // FIX: Header structure updated to Absolute Centering for perfect alignment
            container.innerHTML = `
                <div class="fixed inset-0 bg-background-dark z-[60] flex flex-col animate-fade-in overflow-hidden">
                    <!-- Progress Bar -->
                    <div class="h-1 bg-surface-dark w-full relative z-30">
                        <div id="quiz-progress" class="h-full bg-primary transition-all duration-300 ease-out shadow-[0_0_15px_rgba(59,130,246,0.5)]" style="width: ${progress}%"></div>
                    </div>

                    <!-- Header -->
                    <div class="h-16 px-4 md:px-6 flex items-center justify-between shrink-0 relative z-20 bg-background-dark/95 backdrop-blur-md border-b border-border-dark">
                        
                        <!-- Left: Back Button (Z-Index High to stay clickable) -->
                        <div class="flex items-center justify-start shrink-0 relative z-10">
                            <button onclick="router('content')" class="text-text-muted hover:text-white transition-colors flex items-center justify-center w-10 h-10 rounded-xl bg-surface-dark border border-border-dark hover:bg-card-dark shrink-0">
                                <span class="material-symbols-rounded text-xl">arrow_back</span>
                            </button>
                        </div>

                        <!-- Center: Title (Absolute Positioning for Perfect Centering) -->
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none px-20 md:px-32">
                            <h2 class="text-base md:text-lg font-bold text-white truncate text-center w-full pointer-events-auto" title="${test.title}">${test.title}</h2>
                        </div>

                        <!-- Right: Actions (Z-Index High to stay clickable) -->
                        <div class="flex items-center justify-end gap-3 shrink-0 relative z-10">
                            <div class="hidden sm:block text-xs font-mono text-text-muted bg-surface-dark px-3 py-1.5 rounded-lg border border-border-dark"><span id="quiz-counter-current" class="text-white font-bold">${currentIndex + 1}</span> <span class="opacity-50 mx-0.5">/</span> ${questions.length}</div>
                            <div id="quiz-header-actions" class="flex gap-2">
                                ${currentIndex > 0 ? `<button onclick="quizNav(-1)" class="bg-card-dark text-white hover:bg-gray-800 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 border border-border-dark shadow-lg"><span class="material-symbols-rounded text-lg">arrow_back</span> <span class="hidden md:inline">Önceki</span></button>` : ''}
                                ${currentIndex === questions.length - 1
                                    ? `<button onclick="submitQuiz()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2 animate-fade-in shadow-lg shadow-emerald-500/20">Bitir <span class="material-symbols-rounded text-lg">check</span></button>`
                                    : `<button onclick="quizNav(1)" class="bg-white text-black hover:bg-gray-200 px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2 animate-fade-in shadow-lg">Sonraki <span class="material-symbols-rounded text-lg">arrow_forward</span></button>`
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Body (Vertical Layout) -->
                    <div class="flex-1 w-full h-full overflow-hidden relative z-10 flex flex-col items-center">
                        <div class="w-full max-w-4xl h-full flex flex-col p-4 md:p-6 quiz-content-area overflow-y-auto thin-scroll">
                            
                            <!-- Soru Alanı (Sola Hizalı) -->
                            <div class="flex-none mb-4 text-left">
                                <h2 id="quiz-question-text" class="text-lg md:text-xl font-medium text-white leading-relaxed tracking-normal transition-opacity duration-200 whitespace-pre-wrap">${q.text}</h2>
                            </div>

                            <!-- Şıklar Alanı (Tek Sütun, Dikey Liste) -->
                            <div class="flex-none w-full">
                                <div id="quiz-options-list" class="flex flex-col space-y-3">
                                    ${q.options.map((opt, i) => {
                                        let baseClass = "w-full text-left p-4 rounded-xl option-card relative overflow-hidden flex items-center gap-4 text-text-main text-base font-medium transition-all duration-200 border border-border-dark";
                                        let statusClass = "hover:bg-background-dark hover:border-text-muted";
                                        let letterClass = "border-text-muted text-text-muted";
                                        
                                        if (isAnswered) {
                                            if (i == q.correctIndex) { statusClass = "selected-correct"; letterClass = "border-emerald-500 text-emerald-500"; }
                                            else if (i == ans) { statusClass = "selected-wrong"; letterClass = "border-red-500 text-red-500"; }
                                            else statusClass = "disabled";
                                        }

                                        return `
                                        <button id="opt-btn-${i}" onclick="selectOption('${q.id}', ${i})" class="${baseClass} ${statusClass}" ${isAnswered ? 'disabled' : ''}>
                                            <div class="opt-letter w-8 h-8 rounded-lg border-2 ${letterClass} flex items-center justify-center text-sm font-bold transition-colors shrink-0">
                                                ${String.fromCharCode(65+i)}
                                            </div>
                                            <span class="leading-relaxed text-left">${opt}</span>
                                        </button>`;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- Explanation Area (En Altta) -->
                            <div id="quiz-explanation-wrapper" class="hidden mt-6 animate-fade-in flex-none">
                                <div class="bg-card-dark p-6 rounded-2xl border-l-4 border-white relative shadow-xl">
                                    <div class="flex items-center gap-2 text-white text-xs font-bold uppercase tracking-widest mb-2">
                                        <span class="material-symbols-rounded text-lg">lightbulb</span> AÇIKLAMA
                                    </div>
                                    <p id="quiz-explanation-text" class="text-text-muted text-base leading-relaxed"></p>
                                </div>
                            </div>
                            
                            <!-- Alt boşluk -->
                            <div class="h-8 flex-none"></div> 
                        </div>
                    </div>
                </div>`;
        }

        // --- REVIEW PAGE ---
        function renderQuizReview(container) {
            const { test, questions, answers } = activeQuizData;
            let correctCount = 0;
            const reviewHtml = questions.map((q, idx) => {
                const userAns = answers[q.id];
                const isCorrect = userAns == q.correctIndex;
                if(isCorrect) correctCount++;
                
                const isSkipped = userAns === undefined;
                let borderColor = isSkipped ? 'border-border-dark' : (isCorrect ? 'border-emerald-500/20' : 'border-red-500/20');

                return `
                <div class="glass-card border ${borderColor} p-6 mb-4 bg-background-dark">
                    <div class="flex gap-4 mb-4">
                        <span class="text-text-muted font-bold text-xs bg-card-dark px-3 py-1 h-fit rounded-lg border border-border-dark font-mono">#${idx+1}</span>
                        <p class="text-base text-white font-medium flex-1 leading-relaxed whitespace-pre-wrap">${q.text}</p>
                    </div>
                    <div class="flex flex-col space-y-2 pl-0 md:pl-12">
                        ${q.options.map((opt, i) => {
                            let style = "text-text-muted";
                            let icon = "";
                            if (i === q.correctIndex) { style = "text-emerald-500 font-bold"; icon = "check"; }
                            else if (userAns == i && !isCorrect) { style = "text-red-500 font-medium line-through decoration-red-500/50"; }
                            return `<div class="text-sm ${style} flex items-center gap-3 bg-card-dark p-3 rounded-xl border border-transparent ${i===q.correctIndex ? 'bg-emerald-500/10 border-emerald-500/20' : ''}">${icon ? `<span class="material-symbols-rounded text-lg">${icon}</span>` : '<span class="w-6 h-6 flex items-center justify-center border border-text-muted/30 rounded-full text-[10px]">' + String.fromCharCode(65+i) + '</span>'} ${opt}</div>`;
                        }).join('')}
                    </div>
                    ${isSkipped ? '<div class="mt-3 ml-12 text-xs text-text-muted italic">Boş bırakıldı.</div>' : ''}
                </div>`;
            }).join('');

            container.innerHTML = `
                <div class="animate-fade-in max-w-[1200px] mx-auto pb-10">
                    <div class="flex flex-col items-center justify-center py-12 text-center glass-panel rounded-3xl mb-10 relative overflow-hidden border border-border-dark bg-surface-dark">
                        <div class="w-32 h-32 rounded-full border-[6px] border-background-dark flex items-center justify-center text-4xl font-bold text-white mb-4 relative z-10 shadow-2xl font-display" 
                             style="background: conic-gradient(${correctCount/questions.length > 0.5 ? '#10b981' : '#ef4444'} ${Math.round((correctCount/questions.length)*100)}%, #171717 0);">
                            %${Math.round((correctCount/questions.length)*100)}
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2 font-display">${test.title}</h2>
                        <p class="text-text-muted text-xs font-bold mb-8 uppercase tracking-widest bg-card-dark px-4 py-1.5 rounded-full border border-border-dark">Test Sonucu</p>
                        
                        <div class="flex gap-12 text-center mb-8">
                            <div><p class="text-3xl font-bold text-white font-display">${correctCount}</p><p class="text-[10px] text-emerald-500 uppercase font-bold tracking-wider mt-1">Doğru</p></div>
                            <div><p class="text-3xl font-bold text-white font-display">${questions.length - correctCount}</p><p class="text-[10px] text-red-500 uppercase font-bold tracking-wider mt-1">Yanlış/Boş</p></div>
                            <div><p class="text-3xl font-bold text-white font-display">${questions.length}</p><p class="text-[10px] text-text-dim uppercase font-bold tracking-wider mt-1">Toplam</p></div>
                        </div>

                        <button onclick="router('content')" class="bg-white text-black hover:bg-gray-200 px-8 py-3.5 rounded-xl font-bold text-sm transition-all flex items-center gap-2 shadow-lg hover:scale-105">
                            <span class="material-symbols-rounded text-xl">arrow_back</span> Listeye Dön
                        </button>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-text-muted uppercase tracking-widest mb-6 px-2">Detaylı Analiz</h3>
                        ${reviewHtml}
                    </div>
                </div>`;
        }

        // --- Modals & Data Handling ---
        window.openModal = (type, id = null, subId = null) => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            overlay.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
            
            currentEditingId = type === 'subcategory' ? subId : id;

            if (type === 'global-test-json') {
                title.innerText = id ? 'Testi Düzenle' : 'Yeni Test Oluştur';
                let selCat = contentFilter.catId !== 'all' ? contentFilter.catId : '';
                let selSub = contentFilter.subId !== 'all' ? contentFilter.subId : '';
                let testData = null;
                let jsonContent = '[]';
                
                if (id) {
                    testData = tests.find(t => t.id === id);
                    if (testData) {
                        const sub = subcategories.find(s => s.id === testData.subId);
                        if (sub) { selSub = sub.id; selCat = sub.catId; }
                        const tQs = questions.filter(q => q.testId === id).map(q => ({ text: q.text, options: q.options, correctIndex: q.correctIndex, explanation: q.explanation || "" }));
                        jsonContent = JSON.stringify(tQs, null, 2);
                    }
                }
                const catOpts = categories.map(c => `<option value="${c.id}" ${c.id === selCat ? 'selected' : ''}>${c.name}</option>`).join('');
                
                body.innerHTML = `
                    <form onsubmit="handleSubmit(event, 'global-test-json')" class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] font-bold text-text-muted uppercase block mb-1.5 ml-1">Kategori</label><select id="modal-cat-select" onchange="filterSubcatsInModal()" class="w-full input-immersive rounded-lg p-2.5 text-xs"><option value="">Seçiniz</option>${catOpts}</select></div>
                            <div><label class="text-[10px] font-bold text-text-muted uppercase block mb-1.5 ml-1">Alt Kategori</label><select name="subId" id="modal-sub-select" required class="w-full input-immersive rounded-lg p-2.5 text-xs disabled:opacity-50"><option value="">Önce kategori...</option></select></div>
                        </div>
                        <div><label class="text-[10px] font-bold text-text-muted uppercase block mb-1.5 ml-1">Test Başlığı</label><input name="title" value="${testData?.title || ''}" required class="w-full input-immersive rounded-lg p-2.5 text-xs font-semibold" placeholder="Örn: Tarih Deneme 1"></div>
                        <div>
                            <label class="text-[10px] font-bold text-text-muted uppercase block mb-1.5 ml-1">Açıklama (Opsiyonel)</label>
                            <input name="description" value="${testData?.description || ''}" class="w-full input-immersive rounded-lg p-2.5 text-xs font-medium" placeholder="Test içeriği hakkında kısa bilgi...">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1.5 ml-1">
                                <label class="text-[10px] font-bold text-text-muted uppercase">Sorular (JSON Formatı)</label>
                                <span class="text-[10px] text-white cursor-pointer hover:underline font-bold" onclick="copyExampleJson()">Örnek Şablon Kopyala</span>
                            </div>
                            <textarea name="questionsJson" rows="8" required class="w-full bg-background-dark border border-border-dark rounded-lg p-3 text-text-main font-mono text-[10px] outline-none focus:border-primary transition-colors resize-none shadow-inner">${jsonContent}</textarea>
                        </div>
                        <button class="w-full bg-white hover:bg-neutral-200 text-black py-2.5 rounded-lg font-bold text-xs shadow-lg transition-transform hover:scale-[1.01]">${id ? 'Güncelle' : 'Testi Oluştur'}</button>
                    </form>`;
                setTimeout(() => filterSubcatsInModal(selSub), 100);

            } else if (type === 'category') {
                title.innerText = 'Kategori Yönetimi';
                body.innerHTML = `<form onsubmit="handleSubmit(event, 'category')" class="space-y-4"><div><label class="text-[10px] text-text-muted font-bold uppercase block mb-1.5 ml-1">Kategori Adı</label><input name="name" required class="w-full input-immersive rounded-lg p-2.5 text-sm"></div><button class="w-full bg-white hover:bg-neutral-200 text-black py-2.5 rounded-lg font-bold text-xs shadow-lg">Kaydet</button></form>`;
            } else if (type === 'subcategory') {
                title.innerText = 'Alt Kategori Ekle';
                body.innerHTML = `<form onsubmit="handleSubmit(event, 'subcategory')" class="space-y-4"><input type="hidden" name="catId" value="${id}"><div><label class="text-[10px] text-text-muted font-bold uppercase block mb-1.5 ml-1">Alt Kategori Adı</label><input name="name" required class="w-full input-immersive rounded-lg p-2.5 text-sm"></div><button class="w-full bg-white hover:bg-neutral-200 text-black py-2.5 rounded-lg font-bold text-xs shadow-lg">Kaydet</button></form>`;
            }
        }

        window.filterSubcatsInModal = (preSelectId = null) => {
            const catId = document.getElementById('modal-cat-select').value;
            const subSel = document.getElementById('modal-sub-select');
            if (!catId) { subSel.innerHTML = '<option value="">Önce kategori...</option>'; subSel.disabled = true; return; }
            const subs = subcategories.filter(s => s.catId === catId);
            subSel.innerHTML = subs.length ? subs.map(s => `<option value="${s.id}" ${s.id === preSelectId ? 'selected' : ''}>${s.name}</option>`).join('') : '<option value="">Yok</option>';
            subSel.disabled = !subs.length;
        }
        
        window.copyExampleJson = () => {
            const ex = `[
  {
    "text": "Soru metni buraya",
    "options": ["A Seçeneği", "B Seçeneği", "C Seçeneği", "D Seçeneği", "E Seçeneği"],
    "correctIndex": 0,
    "explanation": "Açıklama metni buraya."
  }
]`;
            navigator.clipboard.writeText(ex);
            showToast("Şablon Kopyalandı");
        }

        window.closeModal = () => { document.getElementById('modal-overlay').classList.add('hidden'); }

        window.handleSubmit = async (e, type) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "İşleniyor..."; btn.disabled = true;
            const fd = new FormData(e.target);
            const d = Object.fromEntries(fd.entries());
            const path = `artifacts/${appId}/users/${currentUser.uid}`;

            try {
                if (type === 'category') {
                     await addDoc(collection(db, path, 'categories'), { name: d.name, createdAt: Date.now() });
                } else if (type === 'subcategory') {
                     await addDoc(collection(db, path, 'subcategories'), { name: d.name, catId: d.catId, createdAt: Date.now() });
                } else if (type === 'global-test-json') {
                    const qs = JSON.parse(d.questionsJson);
                    if (currentEditingId) {
                        await updateDoc(doc(db, path, 'tests', currentEditingId), { 
                            title: d.title, 
                            description: d.description,
                            subId: d.subId, 
                            questionCount: qs.length 
                        });
                        const oldQs = questions.filter(q => q.testId === currentEditingId);
                        oldQs.forEach(async q => await deleteDoc(doc(db, path, 'questions', q.id)));
                        await Promise.all(qs.map(q => addDoc(collection(db, path, 'questions'), { ...q, testId: currentEditingId })));
                    } else {
                        const ref = await addDoc(collection(db, path, 'tests'), { 
                            title: d.title, 
                            description: d.description,
                            subId: d.subId, 
                            questionCount: qs.length, 
                            createdAt: Date.now() 
                        });
                        await Promise.all(qs.map(q => addDoc(collection(db, path, 'questions'), { ...q, testId: ref.id })));
                    }
                }
                closeModal();
                showToast("İşlem Başarılı");
            } catch(err) { showToast("Hata oluştu: " + err.message, "error"); console.error(err); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        }

        window.deleteItem = async (col, id) => {
            if(!confirm("Bu öğeyi kalıcı olarak silmek istiyor musunuz?")) return;
            await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}`, col, id));
            showToast("Öğe Silindi");
        }

        window.showToast = (title, type = "success") => {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = title;
            t.className = `fixed bottom-8 right-8 px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 z-[80] flex items-center gap-3 text-sm font-bold border backdrop-blur-xl ${type === 'error' ? 'bg-bg-card border-red-500/50 text-red-200' : 'bg-bg-card border-emerald-500/50 text-emerald-500'}`;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        init();
    </script>
</body>
</html>
